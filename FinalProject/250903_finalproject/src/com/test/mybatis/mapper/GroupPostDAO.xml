<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.mybatis.dao.IGroupPostDAO">

	<select id="list" resultType="com.test.mybatis.dto.GroupPostDTO">
		SELECT postCode, boardCategory, subject, nickName, joinCode
			 , groupApplyCode, createdDate, commentCount
		FROM(
		SELECT postCode, boardCategory, subject, nickName, joinCode
			 , groupApplyCode, createdDate, commentCount, ROWNUM AS RN
		FROM(
		SELECT PS.POST_CODE AS postCode, BC.TYPE AS boardCategory
			 , PS.SUBJECT AS subject, UI.NICKNAME AS nickName
			 , J.JOIN_CODE AS joinCode
			 , GA.GROUP_APPLY_CODE AS groupApplyCode
			 , TO_CHAR(PS.CREATED_DATE, 'YYYY-MM-DD') AS createdDate
			 , (SELECT COUNT(*)
				FROM POST_COMMENT
				WHERE POST_CODE = PS.POST_CODE) AS commentCount
		FROM POST PS
		LEFT JOIN REPORT_POST RPS ON PS.POST_CODE = RPS.POST_CODE
		LEFT JOIN REPORT_POST_PROCESS RPSPR ON RPSPR.REPORT_POST_CODE = RPS.REPORT_POST_CODE
		LEFT JOIN JOIN_TABLE J ON PS.JOIN_CODE = J.JOIN_CODE
		LEFT JOIN USER_TABLE UT ON UT.USER_CODE = J.USER_CODE
		LEFT JOIN USER_INFO UI ON UI.USER_ID = UT.USER_ID
		LEFT JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
		LEFT JOIN DELETE_POST DPS ON DPS.POST_CODE = PS.POST_CODE
		LEFT JOIN BOARD_CATEGORY BC ON BC.BOARD_CATEGORY = PS.BOARD_CATEGORY
		WHERE NVL(RPSPR.PROCESS_TYPE, 0) NOT IN (4)
		AND DPS.POST_CODE IS NULL
		AND GA.GROUP_APPLY_CODE = '32'
		ORDER BY PS.CREATED_DATE DESC))
		WHERE RN BETWEEN #{start} AND #{end}
	</select>
	
	<select id="listCount" resultType="java.lang.Integer">
		SELECT COUNT(*) AS totalCount
		FROM POST PS
		LEFT JOIN REPORT_POST RPS ON PS.POST_CODE = RPS.POST_CODE
		LEFT JOIN REPORT_POST_PROCESS RPSPR ON RPSPR.REPORT_POST_CODE = RPS.REPORT_POST_CODE
		LEFT JOIN JOIN_TABLE J ON PS.JOIN_CODE = J.JOIN_CODE
		LEFT JOIN USER_TABLE UT ON UT.USER_CODE = J.USER_CODE
		LEFT JOIN USER_INFO UI ON UI.USER_ID = UT.USER_ID
		LEFT JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
		LEFT JOIN DELETE_POST DPS ON DPS.POST_CODE = PS.POST_CODE
		LEFT JOIN BOARD_CATEGORY BC ON BC.BOARD_CATEGORY = PS.BOARD_CATEGORY
		WHERE NVL(RPSPR.PROCESS_TYPE, 0) NOT IN (4)
		AND DPS.POST_CODE IS NULL
		AND GA.GROUP_APPLY_CODE = '32'
		ORDER BY PS.CREATED_DATE
	</select>
	
	<select id="noticeList" resultType="com.test.mybatis.dto.GroupPostDTO">
		SELECT PS.POST_CODE AS POSTCODE, BC.TYPE AS BOARDCATEGORY
		     , PS.SUBJECT AS SUBJECT, UI.NICKNAME AS NICKNAME
		     , J.JOIN_CODE AS JOINCODE
		     , GA.GROUP_APPLY_CODE AS GROUPAPPLYCODE
		     , TO_CHAR(PS.CREATED_DATE, 'YYYY-MM-DD') AS CREATEDDATE
			 , (SELECT COUNT(*)
			    FROM POST_COMMENT
			    WHERE POST_CODE = PS.POST_CODE) COMMENTCOUNT
		FROM POST PS
		LEFT JOIN REPORT_POST RPS ON PS.POST_CODE = RPS.POST_CODE
		LEFT JOIN REPORT_POST_PROCESS RPSPR ON RPSPR.REPORT_POST_CODE = RPS.REPORT_POST_CODE
		LEFT JOIN JOIN_TABLE J ON PS.JOIN_CODE = J.JOIN_CODE
		LEFT JOIN USER_TABLE UT ON UT.USER_CODE = J.USER_CODE
		LEFT JOIN USER_INFO UI ON UI.USER_ID = UT.USER_ID
		LEFT JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
		LEFT JOIN DELETE_POST DPS ON DPS.POST_CODE = PS.POST_CODE
		LEFT JOIN BOARD_CATEGORY BC ON BC.BOARD_CATEGORY = PS.BOARD_CATEGORY
		LEFT JOIN NOTICE_POST NP ON PS.POST_CODE = NP.POST_CODE
		WHERE NVL(RPSPR.PROCESS_TYPE, 0) NOT IN (4)
		AND DPS.POST_CODE IS NULL
		AND NP.POST_CODE IS NOT NULL
		AND GA.GROUP_APPLY_CODE = '32'
		ORDER BY PS.CREATED_DATE
	</select>
	
	<select id="searchList" resultType="com.test.mybatis.dto.GroupPostDTO">
		<!-- 
		SELECT postCode, boardCategory, subject, nickName, joinCode
			 , groupApplyCode, createdDate, commentCount
		FROM(
		SELECT postCode, boardCategory, subject, nickName, joinCode
			 , groupApplyCode, createdDate, commentCount, ROWNUM AS RN
		FROM(
		SELECT PS.POST_CODE AS postCode, BC.TYPE AS boardCategory
			 , PS.SUBJECT AS subject, UI.NICKNAME AS nickName
			 , J.JOIN_CODE AS joinCode
			 , GA.GROUP_APPLY_CODE AS groupApplyCode
			 , TO_CHAR(PS.CREATED_DATE, 'YYYY-MM-DD') AS createdDate
			 , (SELECT COUNT(*)
				FROM POST_COMMENT
				WHERE POST_CODE = PS.POST_CODE) AS commentCount
		FROM POST PS
		LEFT JOIN REPORT_POST RPS ON PS.POST_CODE = RPS.POST_CODE
		LEFT JOIN REPORT_POST_PROCESS RPSPR ON RPSPR.REPORT_POST_CODE = RPS.REPORT_POST_CODE
		LEFT JOIN JOIN_TABLE J ON PS.JOIN_CODE = J.JOIN_CODE
		LEFT JOIN USER_TABLE UT ON UT.USER_CODE = J.USER_CODE
		LEFT JOIN USER_INFO UI ON UI.USER_ID = UT.USER_ID
		LEFT JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
		LEFT JOIN DELETE_POST DPS ON DPS.POST_CODE = PS.POST_CODE
		LEFT JOIN BOARD_CATEGORY BC ON BC.BOARD_CATEGORY = PS.BOARD_CATEGORY
		WHERE NVL(RPSPR.PROCESS_TYPE, 0) NOT IN (4)
		AND DPS.POST_CODE IS NULL
		AND GA.GROUP_APPLY_CODE = '32'
		AND PS.SUBJECT LIKE '%라라%'
		AND PS.CONTENT LIKE '%라라%'
		AND UI.NICKNAME LIKE '%라라%'
		ORDER BY PS.CREATED_DATE DESC))
		WHERE RN BETWEEN 11 AND 12
		 -->
	</select>
	
	<select id="searchListCount" resultType="java.lang.Integer">
	</select>

	<select id="postDetail" resultType="com.test.mybatis.dto.GroupPostDTO">
		SELECT P.POST_CODE AS postCode
			 , BC.TYPE AS boardCategory
			 , P.SUBJECT AS subject
			 , P.CONTENT AS content
			 , UI.NICKNAME AS nickName
			 , JT.GROUP_APPLY_CODE AS groupApplyCode
			 , TO_CHAR(P.CREATED_DATE, 'YYYY-MM-DD HH24:MI:SS') AS createdDate
			 , TO_CHAR(PU.CREATED_DATE, 'YYYY-MM-DD HH24:MI:SS') AS updatedDate
			 , UI.SAVEPATH AS savePath
			 , (SELECT COUNT(*)
				FROM POST_COMMENT
				WHERE POST_CODE = P.POST_CODE) COMMENTCOUNT
			 , CASE WHEN RP.POST_CODE IS NULL THEN 0
					WHEN NVL(RP.POST_CODE, 0)>0 AND RPP.PROCESS_TYPE IN (0, 1, 2)  THEN 0
					WHEN NVL(RP.POST_CODE, 0)>0 AND RPP.PROCESS_TYPE IN (3, 4)  THEN 1
					WHEN RPP.PROCESS_TYPE IS NULL THEN 1
					ELSE 0
			   END AS isBlinded
		FROM POST P
		LEFT JOIN BOARD_CATEGORY BC ON P.BOARD_CATEGORY = BC.BOARD_CATEGORY
		LEFT JOIN JOIN_TABLE JT ON JT.JOIN_CODE = P.JOIN_CODE
		LEFT JOIN USER_TABLE UT ON JT.USER_CODE = UT.USER_CODE
		LEFT JOIN USER_INFO UI ON UI.USER_ID = UT.USER_ID
		LEFT JOIN POST_UPDATE PU ON PU.POST_CODE = P.POST_CODE
		LEFT JOIN REPORT_POST RP ON RP.POST_CODE = P.POST_CODE
		LEFT JOIN REPORT_POST_PROCESS RPP ON RPP.REPORT_POST_CODE = RP.REPORT_POST_CODE
		WHERE P.POST_CODE = #{postCode}
	</select>
	
	<insert id="insertPost">
	</insert>
	
	<update id="updatePost">
	</update>
	
	<delete id="deletePost">
	</delete>
	
	<select id="commentList" resultType="com.test.mybatis.dto.GroupPostCommentDTO">
		SELECT PC.COMMENT_CODE AS commentCode
			 , UI.NICKNAME AS nickName
			 , TO_CHAR(PC.CREATED_DATE, 'YYYY-MM-DD HH24:MI:SS') AS createdDate	
			 , TO_CHAR(CU.CREATED_DATE, 'YYYY-MM-DD HH24:MI:SS') AS updatedDate
			 , PC.CONTENT AS content
			 , UI.SAVEPATH AS savePath
			 , CASE WHEN RC.COMMENT_CODE IS NULL THEN 0
					WHEN NVL(RC.COMMENT_CODE, 0)>0 AND RCP.PROCESS_TYPE IN (0, 1, 2)  THEN 0
					WHEN NVL(RC.COMMENT_CODE, 0)>0 AND RCP.PROCESS_TYPE IN (3, 4)  THEN 1
					WHEN RCP.PROCESS_TYPE IS NULL THEN 1
					ELSE 0
			   END AS isBlinded
			   , JT.JOIN_CODE
			   , PC.COMMENT_CODE
		FROM POST_COMMENT PC
		LEFT JOIN JOIN_TABLE JT ON PC.JOIN_CODE = JT.JOIN_CODE
		LEFT JOIN USER_TABLE UT ON JT.USER_CODE = UT.USER_CODE
		LEFT JOIN USER_INFO UI ON UT.USER_ID = UI.USER_ID
		LEFT JOIN COMMENT_UPDATE CU ON CU.COMMENT_CODE = PC.COMMENT_CODE
		LEFT JOIN REPORT_COMMENT RC ON RC.COMMENT_CODE = PC.COMMENT_CODE
		LEFT JOIN REPORT_COMMENT_PROCESS RCP ON RCP.REPORT_COMMENT_CODE = RC.REPORT_COMMENT_CODE
		WHERE PC.POST_CODE = #{postCode}
	</select>
	
	
	
	<insert id="insertComment">
	</insert>
	
	<update id="updateComment">
	</update>
	
	<delete id="deleteComment">
	</delete>
	
	<select id="postListAtHome" resultType="com.test.mybatis.dto.GroupPostDTO">
		SELECT P.POST_CODE AS postCode
		     , BC.TYPE AS boardCategory
		     , P.SUBJECT AS subject
		     , P.CONTENT AS content
		     , UI.NICKNAME AS nickName
		     , JT.GROUP_APPLY_CODE AS groupApplyCode
		     , TO_CHAR(P.CREATED_DATE, 'YYYY-MM-DD HH24:MI:SS') AS createdDate
		     , TO_CHAR(PU.CREATED_DATE, 'YYYY-MM-DD HH24:MI:SS') AS updatedDate
		     , UI.SAVEPATH AS savePath
		     , (SELECT COUNT(*)
		        FROM POST_COMMENT
		        WHERE POST_CODE = P.POST_CODE) COMMENTCOUNT
		     , CASE WHEN RP.POST_CODE IS NULL THEN 0
		            WHEN NVL(RP.POST_CODE, 0)>0 AND RPP.PROCESS_TYPE IN (0, 1, 2)  THEN 0
		            WHEN NVL(RP.POST_CODE, 0)>0 AND RPP.PROCESS_TYPE IN (3, 4)  THEN 1
		            WHEN RPP.PROCESS_TYPE IS NULL THEN 1
		            ELSE 0
		       END AS isBlinded
		FROM POST P
		LEFT JOIN BOARD_CATEGORY BC ON P.BOARD_CATEGORY = BC.BOARD_CATEGORY
		LEFT JOIN JOIN_TABLE JT ON JT.JOIN_CODE = P.JOIN_CODE
		LEFT JOIN USER_TABLE UT ON JT.USER_CODE = UT.USER_CODE
		LEFT JOIN USER_INFO UI ON UI.USER_ID = UT.USER_ID
		LEFT JOIN POST_UPDATE PU ON PU.POST_CODE = P.POST_CODE
		LEFT JOIN REPORT_POST RP ON RP.POST_CODE = P.POST_CODE
		LEFT JOIN REPORT_POST_PROCESS RPP ON RPP.REPORT_POST_CODE = RP.REPORT_POST_CODE
		WHERE JT.GROUP_APPLY_CODE = #{groupApplyCode}
		AND P.BOARD_CATEGORY = 1
		ORDER BY P.CREATED_DATE DESC
	</select>
	
</mapper>