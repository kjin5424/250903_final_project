<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.mybatis.dao.IAttendanceDAO">

	<select id="getAttendanceList" resultType="com.test.mybatis.dto.AttendanceDTO">
		SELECT VJ.JOIN_CODE AS JOINCODE, UI.NICKNAME AS NICKNAME, GA.GROUP_APPLY_CODE AS GROUPAPPLYCODE
		     , COUNT(ACV.ACTIVITY_VOTE_CODE) AS TOTALACTIVITYCOUNT, COUNT(ATT.ACTIVITY_VOTE_CODE) AS TOTALATTENDANCECOUNT
		     , NVL((SELECT PT.TYPE
		            FROM MEMBER_POSITION MP
		            JOIN POSITION_TYPE PT ON PT.POSITION_TYPE = MP.POSITION_TYPE
		            WHERE MP.JOIN_CODE = VJ.JOIN_CODE), '모임원') AS POSITION
		FROM ACTIVITY_VOTE ACV
		LEFT JOIN ACTIVITY AC ON AC.ACTIVITY_CODE = ACV.ACTIVITY_CODE
		JOIN JOIN_TABLE ACJ ON AC.JOIN_CODE = ACJ.JOIN_CODE
		JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = ACJ.GROUP_APPLY_CODE
		JOIN JOIN_TABLE VJ ON VJ.JOIN_CODE = ACV.JOIN_CODE
		JOIN USER_TABLE UT ON UT.USER_CODE = VJ.USER_CODE
		JOIN USER_INFO UI ON UI.USER_ID = UT.USER_ID
		LEFT JOIN ATTENDANCE ATT ON ATT.ACTIVITY_VOTE_CODE = ACV.ACTIVITY_VOTE_CODE
		WHERE GA.GROUP_APPLY_CODE = #{groupApplyCode}
		GROUP BY VJ.JOIN_CODE, UI.NICKNAME, GA.GROUP_APPLY_CODE
		ORDER BY CASE POSITION
		            WHEN '모임장' THEN 1
		            WHEN '부모임장' THEN 2
		            WHEN '도우미' THEN 3
		            ELSE 4
		        END
	</select>
	
</mapper>