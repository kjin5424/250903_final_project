<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.mybatis.dao.IActivityDAO">

	<select id="activityListAtHome" resultType="com.test.mybatis.dto.ActivityDTO">
		SELECT CONTENT, PLACE, ONOFFLINE, ACTIVEDATE, GROUPAPPLYCODE, ACTIVITYCODE
		     , TOTALMEMBER, ATTENDANCEMEMBER, TIME, JOINCODE, REGISTRANTS
		FROM
		(
		    SELECT AC.CONTENT, AC.AT_WHERE AS PLACE, AC.ACTIVITY_CODE AS ACTIVITYCODE
		         , ONOFF.TYPE AS ONOFFLINE, AC.ACTIVE_DATE AS ACTIVEDATE, AC.TIME AS TIME
		         , GLV.GROUPAPPLYCODE, J.JOIN_CODE AS JOINCODE
		         , (SELECT COUNT(ACV.ACTIVITY_VOTE_CODE)
		            FROM ACTIVITY_VOTE ACV
		            LEFT JOIN JOIN_TABLE J ON ACV.JOIN_CODE = J.JOIN_CODE
		            WHERE ACV.ACTIVITY_CODE = AC.ACTIVITY_CODE) AS TOTALMEMBER
		         , (SELECT COUNT(ACV.ACTIVITY_VOTE_CODE)
		            FROM ACTIVITY_VOTE ACV
		            LEFT JOIN JOIN_TABLE J ON ACV.JOIN_CODE = J.JOIN_CODE
		            WHERE ACV.ACTIVITY_CODE = AC.ACTIVITY_CODE
		            AND ACV.Y_OR_N_TYPE = 1) AS REGISTRANTS
		         , (SELECT COUNT(ATT.ACTIVITY_VOTE_CODE)
		            FROM ATTENDANCE ATT
		            LEFT JOIN ACTIVITY_VOTE ACV ON ACV.ACTIVITY_VOTE_CODE = ATT.ACTIVITY_VOTE_CODE
		            LEFT JOIN JOIN_TABLE J ON ACV.JOIN_CODE = J.JOIN_CODE
		            WHERE ACV.ACTIVITY_CODE = AC.ACTIVITY_CODE) AS ATTENDANCEMEMBER
		         , RANK() OVER(PARTITION BY GLV.GROUPAPPLYCODE ORDER BY AC.ACTIVE_DATE) AS RN
		    FROM ACTIVITY AC
		    LEFT JOIN JOIN_TABLE J ON J.JOIN_CODE = AC.JOIN_CODE
		    LEFT JOIN GROUP_LIST_VIEW GLV ON GLV.GROUPAPPLYCODE = J.GROUP_APPLY_CODE
		    LEFT JOIN ONOFFLINE_TYPE ONOFF ON ONOFF.ONOFFLINE_TYPE = AC.ONOFFLINE_TYPE
		    WHERE AC.ACTIVE_DATE &gt; SYSDATE
		) 
		WHERE RN &lt;= 2
		AND GROUPAPPLYCODE = #{groupApplyCode}
	</select>
	
	<select id="activityForGroup" resultType="com.test.mybatis.dto.ActivityDTO" parameterType="com.test.mybatis.dto.ActivityDTO">
		SELECT CONTENT, PLACE, ONOFFLINE, ACTIVEDATE, GROUPAPPLYCODE, ACTIVITYCODE
		     , TOTALMEMBER, ATTENDANCEMEMBER, TIME, JOINCODE, REGISTRANTS, TO_CHAR(CREATEDDATE, 'YYYY-MM-DD') AS CREATEDDATE
		     , TO_CHAR((ACTIVEDATE-1), 'YYYY-MM-DD') AS LIMITVOTEDATE
		     , (ACTIVEDATE + (TO_NUMBER(TIME)/24)) AS ACTIVEENDTIME
		     , CASE WHEN (SYSDATE > ACTIVEDATE + (TO_NUMBER(TIME)/24)) THEN '활동 완료'
		            WHEN (SYSDATE >= ACTIVEDATE-1) THEN '활동중'
		            ELSE '투표중'
		       END AS STATUS
		FROM
		(
		    SELECT AC.CONTENT, AC.AT_WHERE AS PLACE, AC.ACTIVITY_CODE AS ACTIVITYCODE
		         , ONOFF.TYPE AS ONOFFLINE, AC.ACTIVE_DATE AS ACTIVEDATE, AC.TIME AS TIME
		         , GLV.GROUPAPPLYCODE, J.JOIN_CODE AS JOINCODE, AC.CREATED_DATE AS CREATEDDATE
		         , (SELECT COUNT(ACV.ACTIVITY_VOTE_CODE)
		            FROM ACTIVITY_VOTE ACV
		            LEFT JOIN JOIN_TABLE J ON ACV.JOIN_CODE = J.JOIN_CODE
		            WHERE ACV.ACTIVITY_CODE = AC.ACTIVITY_CODE) AS TOTALMEMBER
		         , (SELECT COUNT(ACV.ACTIVITY_VOTE_CODE)
		            FROM ACTIVITY_VOTE ACV
		            LEFT JOIN JOIN_TABLE J ON ACV.JOIN_CODE = J.JOIN_CODE
		            WHERE ACV.ACTIVITY_CODE = AC.ACTIVITY_CODE
		            AND ACV.Y_OR_N_TYPE = 1) AS REGISTRANTS
		         , (SELECT COUNT(ATT.ACTIVITY_VOTE_CODE)
		            FROM ATTENDANCE ATT
		            LEFT JOIN ACTIVITY_VOTE ACV ON ACV.ACTIVITY_VOTE_CODE = ATT.ACTIVITY_VOTE_CODE
		            LEFT JOIN JOIN_TABLE J ON ACV.JOIN_CODE = J.JOIN_CODE
		            WHERE ACV.ACTIVITY_CODE = AC.ACTIVITY_CODE) AS ATTENDANCEMEMBER
		         , RANK() OVER(PARTITION BY GLV.GROUPAPPLYCODE ORDER BY AC.ACTIVE_DATE) AS RN
		    FROM ACTIVITY AC
		    LEFT JOIN JOIN_TABLE J ON J.JOIN_CODE = AC.JOIN_CODE
		    LEFT JOIN GROUP_LIST_VIEW GLV ON GLV.GROUPAPPLYCODE = J.GROUP_APPLY_CODE
		    LEFT JOIN ONOFFLINE_TYPE ONOFF ON ONOFF.ONOFFLINE_TYPE = AC.ONOFFLINE_TYPE
		)
		WHERE GROUPAPPLYCODE = #{activityDTO.groupApplyCode}
		AND RN BETWEEN #{activityDTO.start} AND #{activityDTO.end}
		ORDER BY RN DESC
	</select>
	
	<select id="countActivity" resultType="java.lang.Integer">
		SELECT COUNT(AC.ACTIVITY_CODE) AS TOTALDATACOUNT
		FROM ACTIVITY AC
		JOIN JOIN_TABLE J ON J.JOIN_CODE = AC.JOIN_CODE
		JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
		WHERE GA.GROUP_APPLY_CODE = #{groupApplyCode}
	</select>
	
	<insert id="addActivity" parameterType="com.test.mybatis.dto.ActivityDTO" statementType="CALLABLE">
		{CALL PRC_ACTIVITY_INSERT(#{dto.joinCode, jdbcType=VARCHAR}, TO_DATE(#{dto.activeDate}, 'YYYY-MM-DD HH24:MI:SS'), #{dto.onOffLine, jdbcType=VARCHAR}, #{dto.time, jdbcType=VARCHAR}, #{dto.place, jdbcType=VARCHAR}, #{dto.content, jdbcType=VARCHAR})}
	</insert>
	
	<select id="getMyVoteStatus" resultType="java.lang.Integer">
		SELECT Y_OR_N_TYPE AS myVoteStatus
		FROM ACTIVITY_VOTE
		WHERE ACTIVITY_CODE = #{activityCode}
		  AND JOIN_CODE = #{joinCode}
	</select>
	
	<update id="submitVote">
		UPDATE ACTIVITY_VOTE
		SET Y_OR_N_TYPE = #{yOrNType}
		WHERE ACTIVITY_CODE = #{activityCode}
		  AND JOIN_CODE = #{joinCode}
	</update>
	
	<delete id="deleteActivity">
		DELETE FROM ACTIVITY
		WHERE ACTIVITY_CODE = #{activityCode}
	</delete>
	
</mapper>