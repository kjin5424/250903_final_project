<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.mybatis.dao.IGroupDAO">

	<select id="groupList" resultType="com.test.mybatis.dto.GroupDTO">
		WITH
		LASTEST_TITLE AS (
		    SELECT GROUP_APPLY_CODE, TITLE
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM TITLE
		),
		LASTEST_GROUP_CONTENT AS (
		    SELECT GROUP_APPLY_CODE, CONTENT
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM GROUP_CONTENT
		),
		LASTEST_TOPIC AS (
		    SELECT GROUP_APPLY_CODE, TOPIC_TYPE, TOPIC_CODE
		         , (SELECT TYPE FROM TOPIC_TYPE WHERE TP.TOPIC_TYPE=TOPIC_TYPE)AS TOPIC
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM TOPIC TP
		),
		LASTEST_YOUTH AS (
		    SELECT GROUP_APPLY_CODE, Y_OR_N_TYPE
		         , (SELECT TYPE FROM Y_OR_N_TYPE WHERE YF.Y_OR_N_TYPE=Y_OR_N_TYPE) AS YOUTH_FRIENDLY
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM YOUTH_FRIENDLY YF
		),
		LASTEST_GENDER AS (
		    SELECT GROUP_APPLY_CODE, Y_OR_N_TYPE
		         , (SELECT TYPE FROM Y_OR_N_TYPE WHERE G.Y_OR_N_TYPE=Y_OR_N_TYPE) AS GENDER_LOCK
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM GENDER G
		),
		LASTEST_QUESTION AS (
		    SELECT GROUP_APPLY_CODE, QUESTION_CODE
		         , CONTENT AS QUESTION
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM QUESTION
		),
		LASTEST_RULE AS (
		    SELECT GROUP_APPLY_CODE, CONTENT AS RULE
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM RULE
		),
		LASTEST_KICKOUT AS (
		    SELECT GROUP_APPLY_CODE, COUNT AS KICK_COUNT
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM KICKOUT
		),
		LASTEST_SECRET AS (
		    SELECT GROUP_APPLY_CODE, PASSWORD
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM SECRET
		),
		LASTEST_HEADCOUNT AS (
		    SELECT GROUP_APPLY_CODE, COUNT AS HEAD_COUNT
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM HEADCOUNT
		),
		LASTEST_LEVEL AS (
		    SELECT GROUP_APPLY_CODE, LEVEL_TYPE
		         , (SELECT COUNT FROM LEVEL_TYPE WHERE LT.LEVEL_TYPE=LEVEL_TYPE) AS MAX_COUNT
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM LEVEL_TABLE LT
		),
		LASTEST_REGION AS (
		    SELECT GROUP_APPLY_CODE, REGION
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM REGION
		)
		SELECT
			   GA.GROUP_APPLY_CODE AS groupApplyCode
		     , GA.USER_CODE AS proposerCode
		     , TT.TITLE AS groupTitle
		     , GC.CONTENT AS groupContent
		     , TP.TOPIC_TYPE AS topicType
		     , TP.TOPIC AS topic
		     , YT.Y_OR_N_TYPE AS youthFriendlyType
		     , YT.YOUTH_FRIENDLY youthFriendly
		     , GN.Y_OR_N_TYPE AS genderType
		     , GN.GENDER_LOCK AS gender
		     , QN.QUESTION_CODE AS questionCode
		     , QN.QUESTION AS question
		     , RL.RULE AS rule
		     , KO.KICK_COUNT AS kickOut
		     , SC.PASSWORD AS password
     		 , COALESCE(HC.HEAD_COUNT, LV.MAX_COUNT, 5) AS headCount
		     , NVL(LV.LEVEL_TYPE, 1) AS groupLevel
		     , NVL(LV.MAX_COUNT, 5) AS maxCount
		     , RE.REGION AS region
		     , GA.ONOFFLINE_TYPE AS onOffType
		     , (SELECT TYPE FROM ONOFFLINE_TYPE WHERE GA.ONOFFLINE_TYPE=ONOFFLINE_TYPE) AS onOff
		     , GA.FREQUENCY_TYPE AS frequenctType
		     , (SELECT TYPE FROM FREQUENCY_TYPE WHERE GA.FREQUENCY_TYPE=FREQUENCY_TYPE) AS frequency
		     , GA.DIFFICULTY_TYPE AS difficultyType
		     , (SELECT TYPE FROM DIFFICULTY_TYPE WHERE GA.DIFFICULTY_TYPE=DIFFICULTY_TYPE) AS difficulty
		     , GA.SAVEPATH AS savePath
		     , GA.CREATED_DATE AS createdDate 
		     , GA.OPEN_DATE AS openDate
		FROM
			GROUP_APPLY GA
		LEFT JOIN LASTEST_TITLE TT ON TT.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND TT.RN=1
		LEFT JOIN LASTEST_GROUP_CONTENT GC ON GC.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND GC.RN=1
		LEFT JOIN LASTEST_TOPIC TP ON TP.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND TP.RN=1
		LEFT JOIN LASTEST_YOUTH YT ON YT.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND YT.RN=1
		LEFT JOIN LASTEST_GENDER GN ON GN.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND GN.RN=1
		LEFT JOIN LASTEST_QUESTION QN ON QN.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND QN.RN=1
		LEFT JOIN LASTEST_RULE RL ON RL.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND RL.RN=1
		LEFT JOIN LASTEST_KICKOUT KO ON KO.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND KO.RN=1
		LEFT JOIN LASTEST_SECRET SC ON SC.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND SC.RN=1
		LEFT JOIN LASTEST_HEADCOUNT HC ON HC.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND HC.RN=1
		LEFT JOIN LASTEST_LEVEL LV ON LV.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND LV.RN=1
		LEFT JOIN LASTEST_REGION RE ON RE.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND RE.RN=1
		WHERE
			ROWNUM <![CDATA[<=]]> 5
	</select>
	
	<select id="groupMemberCount" resultType="java.lang.Integer">
		SELECT
			COUNT(*) AS currentMemberCount
		FROM
			GROUP_APPLY GA
		LEFT JOIN JOIN_TABLE JB	ON GA.GROUP_APPLY_CODE=JB.GROUP_APPLY_CODE
		LEFT JOIN REQUEST_ANSWER RA	ON JB.JOIN_CODE=RA.JOIN_CODE
		LEFT JOIN QUIT_MEMBER QM ON JB.JOIN_CODE=QM.JOIN_CODE
		WHERE
			GA.GROUP_APPLY_CODE=#{groupApplyCode}
		  	AND RA.ANSWER_TYPE=1
		  	AND QM.JOIN_CODE IS NULL
	</select>
	
	<insert id="groupApply" parameterType="com.test.mybatis.dto.GroupDTO" statementType="CALLABLE">
		{CALL PRC_GROUP_APPLY_INSERT(#{proposerCode, jdbcType=VARCHAR}, #{onOffType, jdbcType=INTEGER}, #{frequencyType, jdbcType=INTEGER}, #{difficultyType, jdbcType=INTEGER}, #{savePath, jdbcType=VARCHAR},#{groupTitle, jdbcType=VARCHAR},#{groupContent, jdbcType=VARCHAR}, #{topicType, jdbcType=INTEGER}, #{youthFriendlyType, jdbcType=INTEGER}, #{genderType, jdbcType=INTEGER}, #{question, jdbcType=VARCHAR}, #{rule, jdbcType=VARCHAR}, #{kickOut, jdbcType=INTEGER}, #{password, jdbcType=VARCHAR}, #{region, jdbcType=VARCHAR})}
	</insert>

</mapper>





















