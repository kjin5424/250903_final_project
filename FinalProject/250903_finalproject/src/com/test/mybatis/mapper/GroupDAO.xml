<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.mybatis.dao.IGroupDAO">

	<select id="groupList" resultType="com.test.mybatis.dto.GroupDTO">
		WITH
		LASTEST_TITLE AS (
		    SELECT GROUP_APPLY_CODE, TITLE
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM TITLE
		),
		LASTEST_GROUP_CONTENT AS (
		    SELECT GROUP_APPLY_CODE, CONTENT
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM GROUP_CONTENT
		),
		LASTEST_TOPIC AS (
		    SELECT GROUP_APPLY_CODE, TOPIC_TYPE, TOPIC_CODE
		         , (SELECT TYPE FROM TOPIC_TYPE WHERE TP.TOPIC_TYPE=TOPIC_TYPE)AS TOPIC
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM TOPIC TP
		),
		LASTEST_YOUTH AS (
		    SELECT GROUP_APPLY_CODE, Y_OR_N_TYPE
		         , (SELECT TYPE FROM Y_OR_N_TYPE WHERE YF.Y_OR_N_TYPE=Y_OR_N_TYPE) AS YOUTH_FRIENDLY
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM YOUTH_FRIENDLY YF
		),
		LASTEST_GENDER AS (
		    SELECT GROUP_APPLY_CODE, Y_OR_N_TYPE
		         , (SELECT TYPE FROM Y_OR_N_TYPE WHERE G.Y_OR_N_TYPE=Y_OR_N_TYPE) AS GENDER_LOCK
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM GENDER G
		),
		LASTEST_QUESTION AS (
		    SELECT GROUP_APPLY_CODE, QUESTION_CODE
		         , CONTENT AS QUESTION
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM QUESTION
		),
		LASTEST_RULE AS (
		    SELECT GROUP_APPLY_CODE, CONTENT AS RULE
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM RULE
		),
		LASTEST_KICKOUT AS (
		    SELECT GROUP_APPLY_CODE, COUNT AS KICK_COUNT
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM KICKOUT
		),
		LASTEST_SECRET AS (
		    SELECT GROUP_APPLY_CODE, PASSWORD
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM SECRET
		),
		LASTEST_HEADCOUNT AS (
		    SELECT GROUP_APPLY_CODE, COUNT AS HEAD_COUNT
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM HEADCOUNT
		),
		LASTEST_LEVEL AS (
		    SELECT GROUP_APPLY_CODE, LEVEL_TYPE
		         , (SELECT COUNT FROM LEVEL_TYPE WHERE LT.LEVEL_TYPE=LEVEL_TYPE) AS MAX_COUNT
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM LEVEL_TABLE LT
		),
		LASTEST_REGION AS (
		    SELECT GROUP_APPLY_CODE, REGION
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM REGION
		),
		REPORTED_GROUP AS (
		    SELECT GROUP_APPLY_CODE
		    FROM REPORT_GROUP PG
		    LEFT JOIN REPORT_GROUP_PROCESS PGP
		        ON PG.REPORT_GROUP_CODE=PGP.REPORT_GROUP_CODE
		    WHERE PGP.PROCESS_TYPE=2
		      OR (PGP.PROCESS_TYPE=1 AND PGP.CREATED_DATE+14 > SYSDATE)
		)
		SELECT
			   GA.GROUP_APPLY_CODE AS groupApplyCode
		     , GA.USER_CODE AS proposerCode
		     , TT.TITLE AS groupTitle
		     , GC.CONTENT AS groupContent
		     , TP.TOPIC_TYPE AS topicType
		     , TP.TOPIC AS topic
		     , YT.Y_OR_N_TYPE AS youthFriendlyType
		     , YT.YOUTH_FRIENDLY youthFriendly
		     , GN.Y_OR_N_TYPE AS genderType
		     , GN.GENDER_LOCK AS gender
		     , QN.QUESTION_CODE AS questionCode
		     , QN.QUESTION AS question
		     , RL.RULE AS rule
		     , KO.KICK_COUNT AS kickOut
		     , SC.PASSWORD AS password
     		 , COALESCE(HC.HEAD_COUNT, LV.MAX_COUNT, 5) AS headCount
		     , NVL(LV.LEVEL_TYPE, 1) AS groupLevel
		     , NVL(LV.MAX_COUNT, 5) AS maxCount
		     , RE.REGION AS region
		     , GA.ONOFFLINE_TYPE AS onOffType
		     , (SELECT TYPE FROM ONOFFLINE_TYPE WHERE GA.ONOFFLINE_TYPE=ONOFFLINE_TYPE) AS onOff
		     , GA.FREQUENCY_TYPE AS frequenctType
		     , (SELECT TYPE FROM FREQUENCY_TYPE WHERE GA.FREQUENCY_TYPE=FREQUENCY_TYPE) AS frequency
		     , GA.DIFFICULTY_TYPE AS difficultyType
		     , (SELECT TYPE FROM DIFFICULTY_TYPE WHERE GA.DIFFICULTY_TYPE=DIFFICULTY_TYPE) AS difficulty
		     , GA.SAVEPATH AS savePath
		     , GA.CREATED_DATE AS createdDate 
		     , GA.OPEN_DATE AS openDate
		FROM
			GROUP_APPLY GA
		LEFT JOIN LASTEST_TITLE TT ON TT.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND TT.RN=1
		LEFT JOIN LASTEST_GROUP_CONTENT GC ON GC.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND GC.RN=1
		LEFT JOIN LASTEST_TOPIC TP ON TP.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND TP.RN=1
		LEFT JOIN LASTEST_YOUTH YT ON YT.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND YT.RN=1
		LEFT JOIN LASTEST_GENDER GN ON GN.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND GN.RN=1
		LEFT JOIN LASTEST_QUESTION QN ON QN.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND QN.RN=1
		LEFT JOIN LASTEST_RULE RL ON RL.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND RL.RN=1
		LEFT JOIN LASTEST_KICKOUT KO ON KO.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND KO.RN=1
		LEFT JOIN LASTEST_SECRET SC ON SC.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND SC.RN=1
		LEFT JOIN LASTEST_HEADCOUNT HC ON HC.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND HC.RN=1
		LEFT JOIN LASTEST_LEVEL LV ON LV.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND LV.RN=1
		LEFT JOIN LASTEST_REGION RE ON RE.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND RE.RN=1
		LEFT JOIN CLOSE_GROUP CG ON CG.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE
		LEFT JOIN REPORTED_GROUP RG ON RG.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE
		WHERE
			CG.GROUP_APPLY_CODE IS NULL
		  	AND RG.GROUP_APPLY_CODE IS NULL
		  	AND (GA.CREATED_DATE + 7 > SYSDATE OR GA.OPEN_DATE IS NOT NULL)
		  	AND TP.TOPIC_TYPE LIKE #{topicType}
	</select>
	
	
	<select id="searchList" resultType="com.test.mybatis.dto.GroupDTO">
		WITH
		LASTEST_TITLE AS (
		    SELECT GROUP_APPLY_CODE, TITLE
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM TITLE
		),
		LASTEST_GROUP_CONTENT AS (
		    SELECT GROUP_APPLY_CODE, CONTENT
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM GROUP_CONTENT
		),
		LASTEST_TOPIC AS (
		    SELECT GROUP_APPLY_CODE, TOPIC_TYPE, TOPIC_CODE
		         , (SELECT TYPE FROM TOPIC_TYPE WHERE TP.TOPIC_TYPE=TOPIC_TYPE)AS TOPIC
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM TOPIC TP
		),
		LASTEST_YOUTH AS (
		    SELECT GROUP_APPLY_CODE, Y_OR_N_TYPE
		         , (SELECT TYPE FROM Y_OR_N_TYPE WHERE YF.Y_OR_N_TYPE=Y_OR_N_TYPE) AS YOUTH_FRIENDLY
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM YOUTH_FRIENDLY YF
		),
		LASTEST_GENDER AS (
		    SELECT GROUP_APPLY_CODE, Y_OR_N_TYPE
		         , (SELECT TYPE FROM Y_OR_N_TYPE WHERE G.Y_OR_N_TYPE=Y_OR_N_TYPE) AS GENDER_LOCK
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM GENDER G
		),
		LASTEST_QUESTION AS (
		    SELECT GROUP_APPLY_CODE, QUESTION_CODE
		         , CONTENT AS QUESTION
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM QUESTION
		),
		LASTEST_RULE AS (
		    SELECT GROUP_APPLY_CODE, CONTENT AS RULE
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM RULE
		),
		LASTEST_KICKOUT AS (
		    SELECT GROUP_APPLY_CODE, COUNT AS KICK_COUNT
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM KICKOUT
		),
		LASTEST_SECRET AS (
		    SELECT GROUP_APPLY_CODE, PASSWORD
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM SECRET
		),
		LASTEST_HEADCOUNT AS (
		    SELECT GROUP_APPLY_CODE, COUNT AS HEAD_COUNT
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM HEADCOUNT
		),
		LASTEST_LEVEL AS (
		    SELECT GROUP_APPLY_CODE, LEVEL_TYPE
		         , (SELECT COUNT FROM LEVEL_TYPE WHERE LT.LEVEL_TYPE=LEVEL_TYPE) AS MAX_COUNT
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM LEVEL_TABLE LT
		),
		LASTEST_REGION AS (
		    SELECT GROUP_APPLY_CODE, REGION
		         , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
		    FROM REGION
		),
		REPORTED_GROUP AS (
		    SELECT GROUP_APPLY_CODE
		    FROM REPORT_GROUP PG
		    LEFT JOIN REPORT_GROUP_PROCESS PGP
		        ON PG.REPORT_GROUP_CODE=PGP.REPORT_GROUP_CODE
		    WHERE PGP.PROCESS_TYPE=2
		      OR (PGP.PROCESS_TYPE=1 AND PGP.CREATED_DATE+14 > SYSDATE)
		)
		SELECT
			   GA.GROUP_APPLY_CODE AS groupApplyCode
		     , GA.USER_CODE AS proposerCode
		     , TT.TITLE AS groupTitle
		     , GC.CONTENT AS groupContent
		     , TP.TOPIC_TYPE AS topicType
		     , TP.TOPIC AS topic
		     , YT.Y_OR_N_TYPE AS youthFriendlyType
		     , YT.YOUTH_FRIENDLY youthFriendly
		     , GN.Y_OR_N_TYPE AS genderType
		     , GN.GENDER_LOCK AS gender
		     , QN.QUESTION_CODE AS questionCode
		     , QN.QUESTION AS question
		     , RL.RULE AS rule
		     , KO.KICK_COUNT AS kickOut
		     , SC.PASSWORD AS password
     		 , COALESCE(HC.HEAD_COUNT, LV.MAX_COUNT, 5) AS headCount
		     , NVL(LV.LEVEL_TYPE, 1) AS groupLevel
		     , NVL(LV.MAX_COUNT, 5) AS maxCount
		     , RE.REGION AS region
		     , GA.ONOFFLINE_TYPE AS onOffType
		     , (SELECT TYPE FROM ONOFFLINE_TYPE WHERE GA.ONOFFLINE_TYPE=ONOFFLINE_TYPE) AS onOff
		     , GA.FREQUENCY_TYPE AS frequenctType
		     , (SELECT TYPE FROM FREQUENCY_TYPE WHERE GA.FREQUENCY_TYPE=FREQUENCY_TYPE) AS frequency
		     , GA.DIFFICULTY_TYPE AS difficultyType
		     , (SELECT TYPE FROM DIFFICULTY_TYPE WHERE GA.DIFFICULTY_TYPE=DIFFICULTY_TYPE) AS difficulty
		     , GA.SAVEPATH AS savePath
		     , GA.CREATED_DATE AS createdDate 
		     , GA.OPEN_DATE AS openDate
		FROM
			GROUP_APPLY GA
		LEFT JOIN LASTEST_TITLE TT ON TT.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND TT.RN=1
		LEFT JOIN LASTEST_GROUP_CONTENT GC ON GC.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND GC.RN=1
		LEFT JOIN LASTEST_TOPIC TP ON TP.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND TP.RN=1
		LEFT JOIN LASTEST_YOUTH YT ON YT.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND YT.RN=1
		LEFT JOIN LASTEST_GENDER GN ON GN.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND GN.RN=1
		LEFT JOIN LASTEST_QUESTION QN ON QN.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND QN.RN=1
		LEFT JOIN LASTEST_RULE RL ON RL.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND RL.RN=1
		LEFT JOIN LASTEST_KICKOUT KO ON KO.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND KO.RN=1
		LEFT JOIN LASTEST_SECRET SC ON SC.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND SC.RN=1
		LEFT JOIN LASTEST_HEADCOUNT HC ON HC.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND HC.RN=1
		LEFT JOIN LASTEST_LEVEL LV ON LV.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND LV.RN=1
		LEFT JOIN LASTEST_REGION RE ON RE.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND RE.RN=1
		LEFT JOIN CLOSE_GROUP CG ON CG.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE
		LEFT JOIN REPORTED_GROUP RG ON RG.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE
		WHERE
			CG.GROUP_APPLY_CODE IS NULL
		  	AND RG.GROUP_APPLY_CODE IS NULL
		  	<if test="content != null and content != ''">
		  		AND TT.TITLE LIKE '%' || #{content} || '%'
		  	</if>
			<if test="category != null and category.size() > 0">
				AND TP.TOPIC_TYPE IN
				<foreach collection="category" item="item" open="(" separator="," close=")">
					#{item}
				</foreach>
			</if>
			<if test="region != null and region.size() > 0">
			    AND (
			    <foreach collection="region" item="item" separator=" OR ">
			        RE.REGION LIKE '%' || #{item} || '%'
			    </foreach>
			    )
			</if>
			<if test="type != null and type.size() > 0">
				AND ONOFFLINE_TYPE IN
				<foreach collection="type" item="item" open="(" separator=" , " close=")">
					#{item}
				</foreach>
			</if>
			<choose>
				<when test="status != null and status.size() > 0">
				AND
					<foreach collection="status" item="item" open="(" separator=" OR " close=")">
						${item}
					</foreach>
				</when>
				<otherwise>
				  	AND (GA.CREATED_DATE + 7 > SYSDATE OR GA.OPEN_DATE IS NOT NULL)
				</otherwise>
			</choose>
		  	
	</select>
	
	
	<select id="groupMemberCount" resultType="java.lang.Integer">
		SELECT
			COUNT(*) AS currentMemberCount
		FROM
			CURRENT_MEMBER_VIEW
		GROUP BY
			GROUPAPPLYCODE
		HAVING
			GROUPAPPLYCODE=#{groupApplyCode}
	</select>
	
	<insert id="groupApply" parameterType="com.test.mybatis.dto.GroupDTO" statementType="CALLABLE">
		{CALL PRC_GROUP_APPLY_INSERT(#{proposerCode, jdbcType=VARCHAR}, #{onOffType, jdbcType=INTEGER}, #{frequencyType, jdbcType=INTEGER}, #{difficultyType, jdbcType=INTEGER}, #{savePath, jdbcType=VARCHAR},#{groupTitle, jdbcType=VARCHAR},#{groupContent, jdbcType=VARCHAR}, #{topicType, jdbcType=INTEGER}, #{youthFriendlyType, jdbcType=INTEGER}, #{genderType, jdbcType=INTEGER}, #{question, jdbcType=VARCHAR}, #{rule, jdbcType=VARCHAR}, #{kickOut, jdbcType=INTEGER}, #{password, jdbcType=VARCHAR}, #{region, jdbcType=VARCHAR})}
	</insert>
	
	<select id="groupHomeGroupInfo" resultType="com.test.mybatis.dto.GroupDTO">
		SELECT GR.GROUPAPPLYCODE, GR.TITLE AS GROUPTITLE, GR.TOPIC, GR.YOUTHFRIENDLYCODE, GR.GENDERCODE, GR.HEADCOUNT, GR.CURRENTMEMBERCOUNT, RA.CREATED_DATE AS JOINDATE
		     , GR.GROUPLEVEL, GR.CREATEDDATE, GR.OPENDATE
		     , (SELECT TRUNC(NVL((COUNT(DISTINCT CHK.CHALLENGE_CHECK_CODE) * 100.0) 
		                    / NULLIF(COUNT(DISTINCT CD.CHALLENGE_DETAIL_CODE) * COUNT(DISTINCT CM.CHALLENGE_MEMBER_CODE), 0), 0), 2) AS CHECKCHALLENGE
		        FROM CHALLENGE C
		        JOIN JOIN_TABLE J ON C.JOIN_CODE = J.JOIN_CODE
		        LEFT JOIN CHALLENGE_MEMBER CM ON CM.CHALLENGE_CODE = C.CHALLENGE_CODE
		        LEFT JOIN CHALLENGE_DETAIL CD ON CD.CHALLENGE_CODE = C.CHALLENGE_CODE
		        LEFT JOIN CHALLENGE_CHECK CHK ON CHK.CHALLENGE_MEMBER_CODE = CM.CHALLENGE_MEMBER_CODE
		        AND CHK.CHALLENGE_DETAIL_CODE = CD.CHALLENGE_DETAIL_CODE
		        WHERE J.GROUP_APPLY_CODE = GR.GROUPAPPLYCODE)  AS CHECKCHALLENGE
		     , (SELECT NVL((COUNT(DISTINCT A.ACTIVITY_VOTE_CODE) /
		                 NULLIF(COUNT(DISTINCT AV.ACTIVITY_VOTE_CODE), 0) * 100), 0)
		        FROM ACTIVITY_VOTE AV
		        LEFT JOIN ATTENDANCE A ON A.ACTIVITY_VOTE_CODE = AV.ACTIVITY_VOTE_CODE
		        WHERE AV.JOIN_CODE IN (SELECT J.JOIN_CODE 
		                               FROM JOIN_TABLE J
		                               JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
		                               WHERE GA.GROUP_APPLY_CODE = GR.GROUPAPPLYCODE)) AS TOTALATTENDANCE
		     , (SELECT COUNT(AC.ACTIVITY_CODE)
		        FROM ACTIVITY AC
		        LEFT JOIN JOIN_TABLE J ON AC.JOIN_CODE = J.JOIN_CODE
		        LEFT JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
		        WHERE AC.ACTIVE_DATE &lt; SYSDATE
		        AND GA.GROUP_APPLY_CODE = GR.GROUPAPPLYCODE) AS TOTALACTIVITY
		FROM GROUP_LIST_VIEW GR
		LEFT JOIN JOIN_TABLE J ON J.GROUP_APPLY_CODE = GR.GROUPAPPLYCODE AND J.USER_CODE = #{userCode}
		LEFT JOIN REQUEST_ANSWER RA ON RA.JOIN_CODE = J.JOIN_CODE
		WHERE GROUPAPPLYCODE = #{groupApplyCode}
	</select>
	
	<select id="checkMember" resultType="java.lang.Integer">
		SELECT JOINCODE
		FROM CURRENT_MEMBER_VIEW
		WHERE GROUPAPPLYCODE = #{groupApplyCode}
		AND USERCODE = #{userCode}
	</select>
	

	<select id="groupDetail" parameterType="String" resultType="com.test.mybatis.dto.GroupDTO">

WITH 
LASTEST_TITLE AS (
    SELECT 
        GROUP_APPLY_CODE, 
        TITLE, 
        ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
    FROM TITLE
),

LASTEST_GROUP_CONTENT AS (
    SELECT 
        GROUP_APPLY_CODE, 
        CONTENT, 
        ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
    FROM GROUP_CONTENT
),


LASTEST_TOPIC AS (
    SELECT 
        GROUP_APPLY_CODE, 
        TOPIC_TYPE, 
        TOPIC_CODE, 
        (SELECT TYPE FROM TOPIC_TYPE WHERE TP.TOPIC_TYPE = TOPIC_TYPE) AS TOPIC,
        ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
    FROM TOPIC TP
),


LASTEST_YOUTH AS (
    SELECT 
        GROUP_APPLY_CODE, 
        Y_OR_N_TYPE, 
        (SELECT TYPE FROM Y_OR_N_TYPE WHERE YF.Y_OR_N_TYPE = Y_OR_N_TYPE) AS YOUTH_FRIENDLY,
        ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
    FROM YOUTH_FRIENDLY YF
),


LASTEST_GENDER AS (
    SELECT 
        GROUP_APPLY_CODE, 
        Y_OR_N_TYPE, 
        (SELECT TYPE FROM Y_OR_N_TYPE WHERE G.Y_OR_N_TYPE = Y_OR_N_TYPE) AS GENDER_LOCK,
        ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
    FROM GENDER G
),

LASTEST_QUESTION AS (
    SELECT 
        GROUP_APPLY_CODE, 
        QUESTION_CODE, 
        CONTENT AS QUESTION, 
        ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
    FROM QUESTION
),


LASTEST_RULE AS (
    SELECT 
        GROUP_APPLY_CODE, 
        CONTENT AS RULE, 
        ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
    FROM RULE
),


LASTEST_KICKOUT AS (
    SELECT 
        GROUP_APPLY_CODE, 
        COUNT AS KICK_COUNT, 
        ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
    FROM KICKOUT
),


LASTEST_SECRET AS (
    SELECT 
        GROUP_APPLY_CODE, 
        PASSWORD, 
        ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
    FROM SECRET
),


LASTEST_HEADCOUNT AS (
    SELECT 
        GROUP_APPLY_CODE, 
        COUNT AS HEAD_COUNT, 
        ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
    FROM HEADCOUNT
),

LASTEST_LEVEL AS (
    SELECT 
        GROUP_APPLY_CODE, 
        LEVEL_TYPE, 
        (SELECT COUNT FROM LEVEL_TYPE WHERE LT.LEVEL_TYPE = LEVEL_TYPE) AS MAX_COUNT,
        ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
    FROM LEVEL_TABLE LT
),

LASTEST_REGION AS (
    SELECT 
        GROUP_APPLY_CODE, 
        REGION, 
        ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
    FROM REGION
),


REPORTED_GROUP AS (
    SELECT 
        GROUP_APPLY_CODE
    FROM REPORT_GROUP PG
    LEFT JOIN REPORT_GROUP_PROCESS PGP ON PG.REPORT_GROUP_CODE = PGP.REPORT_GROUP_CODE
    WHERE PGP.PROCESS_TYPE = 2 
       OR (PGP.PROCESS_TYPE = 1 AND PGP.CREATED_DATE + 14 > SYSDATE)
)

SELECT 
    GA.GROUP_APPLY_CODE        AS groupApplyCode,
    GA.USER_CODE               AS proposerCode,
    TT.TITLE                   AS groupTitle,
    GC.CONTENT                 AS groupContent,
    TP.TOPIC_TYPE              AS topicType,
    TP.TOPIC                   AS topic,
    YT.Y_OR_N_TYPE             AS youthFriendlyType,
    YT.YOUTH_FRIENDLY          AS youthFriendly,
    GN.Y_OR_N_TYPE             AS genderType,
    GN.GENDER_LOCK             AS gender,
    QN.QUESTION_CODE           AS questionCode,
    QN.QUESTION                AS question,
    RL.RULE                    AS rule,
    KO.KICK_COUNT              AS kickOut,
    SC.PASSWORD                AS password,
    COALESCE(HC.HEAD_COUNT, LV.MAX_COUNT, 5) AS headCount,
    NVL(LV.LEVEL_TYPE, 1)      AS groupLevel,
    NVL(LV.MAX_COUNT, 5)       AS maxCount,
    RE.REGION                  AS region,
    GA.ONOFFLINE_TYPE          AS onOffType,
    (SELECT TYPE FROM ONOFFLINE_TYPE WHERE GA.ONOFFLINE_TYPE = ONOFFLINE_TYPE) AS onOff,
    GA.FREQUENCY_TYPE           AS frequencyType,
    (SELECT TYPE FROM FREQUENCY_TYPE WHERE GA.FREQUENCY_TYPE = FREQUENCY_TYPE) AS frequency,
    GA.DIFFICULTY_TYPE          AS difficultyType,
    (SELECT TYPE FROM DIFFICULTY_TYPE WHERE GA.DIFFICULTY_TYPE = DIFFICULTY_TYPE) AS difficulty,
    GA.SAVEPATH                 AS savePath,
    GA.CREATED_DATE             AS createdDate,
    GA.OPEN_DATE                AS openDate
FROM GROUP_APPLY GA
LEFT JOIN LASTEST_TITLE TT          ON TT.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND TT.RN = 1
LEFT JOIN LASTEST_GROUP_CONTENT GC  ON GC.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND GC.RN = 1
LEFT JOIN LASTEST_TOPIC TP          ON TP.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND TP.RN = 1
LEFT JOIN LASTEST_YOUTH YT          ON YT.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND YT.RN = 1
LEFT JOIN LASTEST_GENDER GN         ON GN.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND GN.RN = 1
LEFT JOIN LASTEST_QUESTION QN       ON QN.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND QN.RN = 1
LEFT JOIN LASTEST_RULE RL           ON RL.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND RL.RN = 1
LEFT JOIN LASTEST_KICKOUT KO        ON KO.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND KO.RN = 1
LEFT JOIN LASTEST_SECRET SC         ON SC.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND SC.RN = 1
LEFT JOIN LASTEST_HEADCOUNT HC      ON HC.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND HC.RN = 1
LEFT JOIN LASTEST_LEVEL LV          ON LV.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND LV.RN = 1
LEFT JOIN LASTEST_REGION RE         ON RE.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND RE.RN = 1
LEFT JOIN CLOSE_GROUP CG            ON CG.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE
LEFT JOIN REPORTED_GROUP RG         ON RG.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE
WHERE GA.GROUP_APPLY_CODE = #{groupApplyCode}
  AND CG.GROUP_APPLY_CODE IS NULL
  AND RG.GROUP_APPLY_CODE IS NULL
  AND (GA.CREATED_DATE + 7 > SYSDATE OR GA.OPEN_DATE IS NOT NULL)

</select>

<select id="groupPassword" parameterType="String"  resultType="String">
	     WITH LASTEST_SECRET AS (
	    SELECT GROUP_APPLY_CODE, PASSWORD
	    , ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
	     FROM SECRET
	)
	 SELECT
	     SC.PASSWORD
	FROM
	    GROUP_APPLY GA
	    LEFT JOIN LASTEST_SECRET SC ON SC.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND SC.RN = 1
	WHERE
	     GA.GROUP_APPLY_CODE = #{groupApplyCode}
	</select>

	<select id="groupUserList" parameterType="String" resultType="com.test.mybatis.dto.GroupDTO">
    	SELECT DISTINCT
        UI.NICKNAME AS nickname,
        J.INTRODUCE AS selfIntroduction,  
        GA.GROUP_APPLY_CODE AS groupApplyCode,
        NVL(CASE WHEN MP.GRANT_TYPE = 1 THEN PST.TYPE ELSE '모임원' END, '모임원') AS position
    FROM
        REQUEST_ANSWER RA
    JOIN
        JOIN_TABLE J ON RA.JOIN_CODE = J.JOIN_CODE
    JOIN
        GROUP_APPLY GA ON J.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE
    LEFT JOIN
        QUIT_MEMBER QM ON RA.JOIN_CODE = QM.JOIN_CODE 
    JOIN
        USER_TABLE UT ON UT.USER_CODE = J.USER_CODE
    JOIN
        USER_INFO UI ON UI.USER_ID = UT.USER_ID
    
    
    LEFT JOIN (
        SELECT JOIN_CODE, POSITION_TYPE, GRANT_TYPE,
               ROW_NUMBER() OVER (PARTITION BY JOIN_CODE ORDER BY CREATED_DATE DESC) AS RN
        FROM MEMBER_POSITION
    ) MP ON RA.JOIN_CODE = MP.JOIN_CODE AND MP.RN = 1
    LEFT JOIN POSITION_TYPE PST ON MP.POSITION_TYPE = PST.POSITION_TYPE
    
    WHERE
        RA.ANSWER_TYPE = 1  
    AND J.GROUP_APPLY_CODE = #{groupApplyCode}
    AND QM.JOIN_CODE IS NULL  
    AND (MP.GRANT_TYPE IN (1,2) OR MP.JOIN_CODE IS NULL) 
    
    
    AND NOT EXISTS (
      SELECT 1 FROM REPORT_MEMBER RM
      JOIN REPORT_MEMBER_PROCESS RMP ON RM.REPORT_MEMBER_CODE = RMP.REPORT_MEMBER_CODE
      WHERE RM.REPORTEE_CODE = RA.JOIN_CODE
        AND RMP.PROCESS_TYPE = 1 
    )
    AND NOT EXISTS (
      SELECT 1 FROM ACTIVITY A
      JOIN REPORT_ACTIVITY RA2 ON RA2.ACTIVITY_CODE = A.ACTIVITY_CODE
      JOIN REPORT_ACTIVITY_PROCESS RAP ON RAP.REPORT_ACTIVITY_CODE = RA2.REPORT_ACTIVITY_CODE
      WHERE A.JOIN_CODE = RA.JOIN_CODE
        AND RAP.PROCESS_TYPE = 4 
    )
    AND NOT EXISTS (
      SELECT 1 FROM POST P
      JOIN REPORT_POST RP ON RP.POST_CODE = P.POST_CODE
      JOIN REPORT_POST_PROCESS RPP ON RPP.REPORT_POST_CODE = RP.REPORT_POST_CODE
      WHERE P.JOIN_CODE = RA.JOIN_CODE
        AND RPP.PROCESS_TYPE = 4
    )
    AND NOT EXISTS (
      SELECT 1 FROM POST_COMMENT PC
      JOIN REPORT_COMMENT RC ON RC.COMMENT_CODE = PC.COMMENT_CODE
      JOIN REPORT_COMMENT_PROCESS RCP ON RCP.REPORT_COMMENT_CODE = RC.REPORT_COMMENT_CODE
      WHERE PC.JOIN_CODE = RA.JOIN_CODE
        AND RCP.PROCESS_TYPE = 4
    )
    AND NOT EXISTS (
      SELECT 1 FROM CHALLENGE C
      JOIN REPORT_CHALLENGE RC ON RC.CHALLENGE_CODE = C.CHALLENGE_CODE
      JOIN REPORT_CHALLENGE_PROCESS RCP ON RCP.REPORT_CHALLENGE_CODE = RC.REPORT_CHALLENGE_CODE
      WHERE C.JOIN_CODE = RA.JOIN_CODE
        AND RCP.PROCESS_TYPE = 4
    )
    AND NOT EXISTS (
      SELECT 1 FROM CHALLENGE_COMMENT CC
      JOIN REPORT_CHALLENGE_COMMENT RCC ON RCC.CHALLENGE_COMMENT_CODE = CC.CHALLENGE_COMMENT_CODE
      JOIN REPORT_CHALLENGE_COMMENT_PROC RCCP
        ON RCCP.REPORT_CHALLENGE_COMMENT_CODE = RCC.REPORT_CHALLENGE_COMMENT_CODE
      WHERE CC.JOIN_CODE = RA.JOIN_CODE
        AND RCCP.PROCESS_TYPE = 4
    )
    AND NOT EXISTS (
      SELECT 1 FROM MESSAGE MS
      JOIN REPORT_MESSAGE RM2 ON RM2.MESSAGE_CODE = MS.MESSAGE_CODE
      JOIN REPORT_MESSAGE_PROCESS RMP2 ON RMP2.REPORT_MESSAGE_CODE = RM2.REPORT_MESSAGE_CODE
      WHERE MS.FORWARDER = RA.JOIN_CODE
        AND RMP2.PROCESS_TYPE = 4
    )
    AND NOT EXISTS (
      SELECT 1 FROM REPORT_USER_INFO RUI
      JOIN REPORT_USER_INFO_PROCESS RUIP
        ON RUIP.REPORT_USER_INFO_CODE = RUI.REPORT_USER_INFO_CODE
      WHERE RUI.REPORTEE = J.USER_CODE
        AND RUIP.PROCESS_TYPE = 4
    )
    AND NOT EXISTS (
      SELECT 1 FROM JOIN_TABLE JT
      JOIN REPORT_INTRODUCE RIN ON RIN.JOIN_CODE = JT.JOIN_CODE
      JOIN REPORT_INTRODUCE_PROCESS RINP ON RINP.REPORT_INTRODUCE_CODE = RIN.REPORT_INTRODUCE_CODE
      WHERE JT.JOIN_CODE = J.USER_CODE
        AND RINP.PROCESS_TYPE = 4
    )
    AND NOT EXISTS (
      SELECT 1 FROM JOIN_TABLE JT
      JOIN REPORT_JOIN_REQUEST RJQ ON RJQ.JOIN_CODE = JT.JOIN_CODE
      JOIN REPORT_JOIN_REQUEST_PROCESS RJQP ON RJQP.REPORT_JOIN_CODE = RJQ.REPORT_JOIN_CODE
      WHERE JT.JOIN_CODE = J.USER_CODE
        AND RJQP.PROCESS_TYPE = 4
    )
    
    ORDER BY
        position DESC,  
        UI.NICKNAME ASC
</select>
	
<select id="groupQuestionRule" parameterType="String" resultType="com.test.mybatis.dto.GroupDTO">
	SELECT
    QN.QUESTION AS question,
    RL.RULE AS rule
FROM
    GROUP_APPLY GA
LEFT JOIN
    ( 
        SELECT
            GROUP_APPLY_CODE,
            CONTENT AS QUESTION,
            ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
        FROM
            QUESTION
    ) QN ON QN.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND QN.RN = 1
LEFT JOIN
    (
        SELECT
            GROUP_APPLY_CODE,
            CONTENT AS RULE,
            ROW_NUMBER() OVER (PARTITION BY GROUP_APPLY_CODE ORDER BY CREATED_DATE DESC) AS RN
        FROM
            RULE
    ) RL ON RL.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE AND RL.RN = 1
WHERE
    GA.GROUP_APPLY_CODE = #{groupApplyCode}
      
</select>

<select id="countActivity" parameterType="string" resultType="int">
	SELECT COUNT(AC.ACTIVITY_CODE) AS totalActivity
	FROM ACTIVITY AC
	JOIN JOIN_TABLE J ON J.JOIN_CODE = AC.JOIN_CODE
	JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
	WHERE GA.GROUP_APPLY_CODE =#{groupApplyCode}
	GROUP BY GA.GROUP_APPLY_CODE
</select>

	<select id="myPageJoinGroup" resultType="com.test.mybatis.dto.GroupDTO">
		SELECT GLV.GROUPAPPLYCODE, GLV.TITLE AS GROUPTITLE, GLV.CURRENTMEMBERCOUNT
           , GLV.HEADCOUNT, GLV.ONOFF
           , (SELECT NVL((COUNT(DISTINCT A.ACTIVITY_VOTE_CODE) /
                             NULLIF(COUNT(DISTINCT AV.ACTIVITY_VOTE_CODE), 0) * 100), 0)
                    FROM ACTIVITY_VOTE AV
                    LEFT JOIN ATTENDANCE A ON A.ACTIVITY_VOTE_CODE = AV.ACTIVITY_VOTE_CODE
                    WHERE AV.JOIN_CODE IN (SELECT J.JOIN_CODE 
                                           FROM JOIN_TABLE J
                                           JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
                                           WHERE GA.GROUP_APPLY_CODE = GLV.GROUPAPPLYCODE)) AS TOTALATTENDANCE
      FROM CURRENT_MEMBER_VIEW CMV
      JOIN GROUP_LIST_VIEW GLV ON CMV.GROUPAPPLYCODE = GLV.GROUPAPPLYCODE
      WHERE CMV.USERCODE = #{userCode}
      AND CMV.POSITION NOT IN ('모임장')
      AND GLV.OPENDATE IS NOT NULL
	</select>
	
	<select id="myPageMyGroup" resultType="com.test.mybatis.dto.GroupDTO">
		SELECT GLV.GROUPAPPLYCODE, GLV.TITLE AS GROUPTITLE, GLV.CURRENTMEMBERCOUNT
           , GLV.HEADCOUNT, GLV.ONOFF
           , (SELECT NVL((COUNT(DISTINCT A.ACTIVITY_VOTE_CODE) /
                             NULLIF(COUNT(DISTINCT AV.ACTIVITY_VOTE_CODE), 0) * 100), 0)
                    FROM ACTIVITY_VOTE AV
                    LEFT JOIN ATTENDANCE A ON A.ACTIVITY_VOTE_CODE = AV.ACTIVITY_VOTE_CODE
                    WHERE AV.JOIN_CODE IN (SELECT J.JOIN_CODE 
                                           FROM JOIN_TABLE J
                                           JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
                                           WHERE GA.GROUP_APPLY_CODE = GLV.GROUPAPPLYCODE)) AS TOTALATTENDANCE
      FROM CURRENT_MEMBER_VIEW CMV
      JOIN GROUP_LIST_VIEW GLV ON CMV.GROUPAPPLYCODE = GLV.GROUPAPPLYCODE
      WHERE CMV.USERCODE = #{userCode}
      AND CMV.POSITION IN ('모임장')
      AND GLV.OPENDATE IS NOT NULL
	</select>
	
	<select id="myPageRequestJoinGroup" resultType="com.test.mybatis.dto.GroupDTO">
		SELECT J.JOIN_CODE, GLV.TITLE AS GROUPTITLE, GLV.HEADCOUNT, GLV.CURRENTMEMBERCOUNT, J.CREATED_DATE AS JOINDATE
		FROM JOIN_TABLE J
		JOIN USER_TABLE UT ON UT.USER_CODE = J.USER_CODE
		LEFT JOIN REQUEST_ANSWER RA ON J.JOIN_CODE = RA.JOIN_CODE
		JOIN GROUP_LIST_VIEW GLV ON GLV.GROUPAPPLYCODE = J.GROUP_APPLY_CODE
		WHERE RA.JOIN_CODE IS NULL
		AND UT.USER_CODE = #{userCode}
	</select>
	
	<select id="myPageRequestApplyGroup" resultType="com.test.mybatis.dto.GroupDTO">
		SELECT GLV.GROUPAPPLYCODE, GLV.TITLE AS GROUPTITLE, GLV.CREATEDDATE
			 , GLV.ONOFF
		FROM GROUP_LIST_VIEW GLV
		LEFT JOIN JOIN_TABLE J ON J.GROUP_APPLY_CODE = GLV.GROUPAPPLYCODE
		JOIN USER_TABLE UT ON UT.USER_CODE = J.USER_CODE
		WHERE J.INTRODUCE = 'AUTO INSERT - 개설신청자'
		AND GLV.OPENDATE IS NULL
		AND UT.USER_CODE = #{userCode}
	</select>
	
	<select id="myPageFavoriteGroup" resultType="com.test.mybatis.dto.GroupDTO">
		SELECT GROUP_APPLY_CODE AS GROUPAPPLYCODE, GLV.TITLE AS GROUPTITLE, GLV.CURRENTMEMBERCOUNT, GLV.HEADCOUNT
		FROM FAVORITE FV
		JOIN GROUP_LIST_VIEW GLV ON GLV.GROUPAPPLYCODE = FV.GROUP_APPLY_CODE
		WHERE USER_CODE = #{userCode}
	</select>


	
	
</mapper>
