<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.mybatis.dao.IGroupJoinDAO">

	<!-- insert 유저가 특정 모임에 가입 신청 -->
	<insert id="insertGroupJoin" parameterType="com.test.mybatis.dto.GroupJoinDTO" statementType="CALLABLE">
		 {CALL PRC_JOIN_TABLE_INSERT(#{userCode, jdbcType=VARCHAR}, #{groupApplyCode, jdbcType=VARCHAR},#{introduce, jdbcType=VARCHAR},#{answer, jdbcType=VARCHAR})}
	</insert>
	
	<!-- 가입 신청 상세 조회 -->
	<select id="selectGroupJoinById" parameterType="string" resultType="com.test.mybatis.dto.GroupJoinDTO">
		SELECT UI.NICKNAME AS NICKNAME, J.CREATED_DATE AS joinDate
	     , J.INTRODUCE AS INTRODUCE, G.GROUP_APPLY_CODE AS groupApplyCode
	     , J.JOIN_CODE AS JOINCODE
	FROM GROUP_APPLY G
	JOIN JOIN_TABLE J ON G.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
	JOIN USER_TABLE UT ON J.USER_CODE = UT.USER_CODE
	JOIN USER_INFO UI ON UT.USER_ID = UI.USER_ID
	LEFT JOIN REQUEST_ANSWER RA ON J.JOIN_CODE = RA.JOIN_CODE
	LEFT JOIN ANSWER_TYPE ANS ON RA.ANSWER_TYPE = ANS.ANSWER_TYPE
	LEFT JOIN REPORT_JOIN_REQUEST RJR ON RJR.JOIN_CODE = J.JOIN_CODE
	LEFT JOIN REPORT_INTRODUCE RI ON RI.JOIN_CODE = J.JOIN_CODE
	WHERE RA.ANSWER_TYPE IS NULL
	AND RI.JOIN_CODE IS NULL
	AND RJR.JOIN_CODE IS NULL
	AND G.GROUP_APPLY_CODE = #{groupApplyCode, jdbcType=VARCHAR}
	</select>
	
	<select id="countWaitingGroupMember" resultType="java.lang.Integer">
		SELECT COUNT(*) AS waitingCount
		FROM JOIN_TABLE JT
		LEFT JOIN REQUEST_ANSWER RA
		    ON JT.JOIN_CODE = RA.JOIN_CODE
		WHERE JT.GROUP_APPLY_CODE = #{groupApplyCode}
		  AND (RA.ANSWER_TYPE IS NULL)
	</select>
	
	
	
	<!-- 중복 신청 체크 -->
	<select id="checkDuplicationGroup" resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM JOIN_TABLE JT
		LEFT JOIN REQUEST_ANSWER RA
			ON JT.JOIN_CODE = RA.JOIN_CODE
		WHERE GROUP_APPLY_CODE = #{groupApplyCode}
  			AND USER_CODE = #{userCode}
 		    AND (RA.ANSWER_TYPE IS NULL OR RA.ANSWER_TYPE = '3') 
	</select>
	
	<!-- 현재 가입된 모임의 수 -->
	<select id="countGroupJoin" resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM JOINED_GROUP_VIEW
		WHERE USER_CODE = #{userCode, jdbcType=VARCHAR}
	</select>
	
	
	<!-- 현재 대기 중인 신청 수 조회 -->
	<select id="countWatingGroup" resultType="java.lang.Integer">
		SELECT COUNT(*) AS waitingCount
		FROM JOIN_TABLE JT
		JOIN REQUEST_ANSWER RA
		ON JT.JOIN_CODE = RA.JOIN_CODE
		WHERE USER_CODE = #{userCode}
		  AND RA.ANSWER_TYPE IS NULL
	</select>
	
	<!-- 가입 상태 업데이트(승락 / 거절) -->
	
	
	<!-- 사용자의 전체 신청 내역 조회 -->
	<select id="selectUserRequest" resultType="com.test.mybatis.dto.GroupJoinDTO">
		SELECT GA.SAVEPATH, T.TITLE, JT.CREATED_DATE, H.COUNT, GCMV.CURRENTMEMBERCOUNT
		FROM JOIN_TABLE JT
		JOIN REQUEST_ANSWER RA
		ON JT.JOIN_CODE = RA.JOIN_CODE
		LEFT JOIN GROUP_APPLY GA
		ON JT.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE
		LEFT JOIN TITLE T
		ON JT.GROUP_APPLY_CODE = T.GROUP_APPLY_CODE
		LEFT JOIN HEADCOUNT H
		ON JT.GROUP_APPLY_CODE = H.GROUP_APPLY_CODE
		LEFT JOIN G_CURRENT_MEMBER_COUNT_VIEW GCMV
		ON JT.GROUP_APPLY_CODE = GCMV.GROUPAPPLYCODE
		WHERE JT.USER_CODE = #{userCode}
		  AND RA.ANSWER_TYPE IS NULL
	</select>
	
	<!-- 모임원 신청서 리스트 보기 -->
	<select id="selectJoinRequestByGroup" resultType="com.test.mybatis.dto.GroupJoinDTO">
	  SELECT 
        JT.JOIN_CODE AS groupJoinCode,
        JT.USER_CODE AS userCode,
        JT.GROUP_APPLY_CODE AS groupApplyCode,
        JT.INTRODUCE AS introduce,
        JT.CREATED_DATE AS joinDate,
        UI.NICKNAME AS nickName,
        UI.EMAIL AS email,
        UI.ADDRESS AS location,
        QA.ANSWER AS answer,
        Q.CONTENT AS question
    FROM JOIN_TABLE JT
    LEFT JOIN USER_TABLE UT
        ON JT.USER_CODE = UT.USER_CODE
    LEFT JOIN USER_INFO UI 
        ON UT.USER_ID = UI.USER_ID
    LEFT JOIN QUESTION_ANSWER QA
        ON JT.JOIN_CODE = QA.JOIN_CODE
    LEFT JOIN GROUP_APPLY GA
        ON JT.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE
    LEFT JOIN QUESTION Q
        ON GA.GROUP_APPLY_CODE = Q.GROUP_APPLY_CODE
    WHERE JT.GROUP_APPLY_CODE =#{groupApplyCode}
      AND NOT EXISTS (
          SELECT 1 
          FROM REQUEST_ANSWER S 
          WHERE S.JOIN_CODE = JT.JOIN_CODE 
      )
    ORDER BY JT.CREATED_DATE DESC
	</select>
	
	<select id="getSelfIntro" resultType="com.test.mybatis.dto.GroupJoinDTO">
		SELECT J.JOIN_CODE AS GROUPJOINCODE, J.INTRODUCE AS INTRODUCE
		FROM JOIN_TABLE J
		JOIN USER_TABLE UT ON UT.USER_CODE = J.USER_CODE
		JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
		JOIN REQUEST_ANSWER RA ON RA.JOIN_CODE = J.JOIN_CODE AND RA.ANSWER_TYPE = 1
		WHERE UT.USER_CODE = #{userCode}
		AND GA.GROUP_APPLY_CODE = #{groupApplyCode}
	</select>
	
	<update id="updateIntroduce">
		UPDATE JOIN_TABLE
		SET INTRODUCE = #{introduce}
		WHERE JOIN_CODE = #{joinCode}
	</update>
	
	<select id="myPageQuitGroup" resultType="com.test.mybatis.dto.GroupJoinDTO">
		SELECT GROUPAPPLYCODE, TITLE AS GROUPTITLE, JOINDATE, QUITDATE, QUIT_REASON AS QUITREASON
		FROM QUITMEMBERVIEW
		WHERE USERCODE = #{userCode}
	</select>


	
	
</mapper>






