<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.mybatis.dao.IGroupJoinDAO">

	<!-- insert 유저가 특정 모임에 가입 신청 -->
	<insert id="insertGroupJoin" parameterType="com.test.mybatis.dto.GroupJoinDTO">
		EXEC PRC_JOIN_TABLE_INSERT(
			#{userCode jdbcType=VARCHAR}
			, #{groupJoinCode}
			, #{selfIntro}
			, #{answer}
			)
	</insert>
	
	<!-- 가입 신청 상세 조회 -->
	<select id="selectGroupJoinById" resultType="com.test.mybatis.dto.GroupJoinDTO">
		SELECT UI.NICKNAME AS NICKNAME, J.CREATED_DATE AS REQUESTDATE
	     , J.INTRODUCE AS INTRODUCE, G.GROUP_APPLY_CODE AS GROUPCODE
	     , J.JOIN_CODE AS JOINCODE
	FROM GROUP_APPLY G
	JOIN JOIN_TABLE J ON G.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
	JOIN USER_TABLE UT ON J.USER_CODE = UT.USER_CODE
	JOIN USER_INFO UI ON UT.USER_ID = UI.USER_ID
	LEFT JOIN REQUEST_ANSWER RA ON J.JOIN_CODE = RA.JOIN_CODE
	LEFT JOIN ANSWER_TYPE ANS ON RA.ANSWER_TYPE = ANS.ANSWER_TYPE
	LEFT JOIN REPORT_JOIN_REQUEST RJR ON RJR.JOIN_CODE = J.JOIN_CODE
	LEFT JOIN REPORT_INTRODUCE RI ON RI.JOIN_CODE = J.JOIN_CODE
	WHERE RA.ANSWER_TYPE IS NULL
	AND RI.JOIN_CODE IS NULL
	AND RJR.JOIN_CODE IS NULL
	AND G.GROUP_APPLY_CODE = #{groupApplyCode}
	</select>
	
	
	
	<!-- 중복 신청 체크 -->
	<select id="checkDuplicationGroup" resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM JOIN_TABLE JT
		LEFT JOIN REQUEST_ANSWER RA
			ON JT.JOIN_CODE = RA.JOIN_CODE
		WHERE GROUP_APPLY_CODE = #{groupApplyCode}
  			AND USER_CODE = #{userCode}
 		    AND (RA.ANSWER_TYPE IS NULL OR RA.ANSWER_TYPE = '3') 
	</select>
	
	<!-- 현재 가입된 모임의 수 -->
	<select id="countGroupJoin" resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM JOINED_GROUP_VIEW
		WHERE USER_CODE = #{userCode, jdbcType=VARCHAR}
	</select>
	
	
	<!-- 현재 대기 중인 신청 수 조회 -->
	<select id="countWatingGroup" resultType="java.lang.Integer">
		SELECT COUNT(*) AS COUNT
		FROM JOIN_TABLE JT
		JOIN REQUEST_ANSWER RA
		ON JT.JOIN_CODE = RA.JOIN_CODE
		WHERE USER_CODE = #{userCode}
		  AND RA.ANSWER_TYPE IS NULL
	</select>
	
	<!-- 가입 상태 업데이트(승락 / 거절) -->
	
	
	<!-- 사용자의 전체 신청 내역 조회 -->
	<select id="selectUserRequest" resultType="com.test.mybatis.dto.GroupJoinDTO">
		SELECT GA.SAVEPATH, T.TITLE, JT.CREATED_DATE, H.COUNT, GCMV.CURRENTMEMBERCOUNT
		FROM JOIN_TABLE JT
		JOIN REQUEST_ANSWER RA
		ON JT.JOIN_CODE = RA.JOIN_CODE
		LEFT JOIN GROUP_APPLY GA
		ON JT.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE
		LEFT JOIN TITLE T
		ON JT.GROUP_APPLY_CODE = T.GROUP_APPLY_CODE
		LEFT JOIN HEADCOUNT H
		ON JT.GROUP_APPLY_CODE = H.GROUP_APPLY_CODE
		LEFT JOIN G_CURRENT_MEMBER_COUNT_VIEW GCMV
		ON JT.GROUP_APPLY_CODE = GCMV.GROUPAPPLYCODE
		WHERE JT.USER_CODE = #{userCode}
		  AND RA.ANSWER_TYPE IS NULL
	</select>
	
	<select id="getSelfIntro" resultType="com.test.mybatis.dto.GroupJoinDTO">
		SELECT J.JOIN_CODE AS GROUPJOINCODE, J.INTRODUCE AS SELFINTRO
		FROM JOIN_TABLE J
		JOIN USER_TABLE UT ON UT.USER_CODE = J.USER_CODE
		JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
		JOIN REQUEST_ANSWER RA ON RA.JOIN_CODE = J.JOIN_CODE AND RA.ANSWER_TYPE = 1
		WHERE UT.USER_CODE = #{userCode}
		AND GA.GROUP_APPLY_CODE = #{groupApplyCode}
	</select>
	
	<update id="updateIntroduce">
		UPDATE JOIN_TABLE
		SET INTRODUCE = #{introduce}
		WHERE JOIN_CODE = #{joinCode}
	</update>
	
	<select id="myPageQuitGroup" resultType="com.test.mybatis.dto.GroupJoinDTO">
		SELECT GROUPAPPLYCODE, TITLE AS GROUPTITLE, JOINDATE, QUITDATE, QUIT_REASON AS QUITREASON
		FROM QUITMEMBERVIEW
		WHERE USERCODE = #{userCode}
	</select>
	
</mapper>






