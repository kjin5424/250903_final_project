<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.mybatis.dao.IMessageDAO">
	<!-- 내가 보낸 쪽지들 -->
	<select id="getReceivedMessage" resultType="com.test.mybatis.dto.MessageDTO">
		SELECT M.MESSAGE_CODE AS messageCode
			 , M.RECEIVER AS receiver
			 , (SELECT NICKNAME
				FROM USER_INFO
				WHERE USER_ID = (SELECT USER_ID
								 FROM USER_TABLE
								 WHERE USER_CODE = (SELECT USER_CODE
													FROM JOIN_TABLE
													WHERE JOIN_CODE = M.RECEIVER))) AS nickName
			 , M.CONTENT AS content
			 , M.CREATED_DATE AS createdDate
			 , (SELECT SAVEPATH
				FROM USER_INFO
				WHERE USER_ID = (SELECT USER_ID
								 FROM USER_TABLE
								 WHERE USER_CODE = (SELECT USER_CODE
													FROM JOIN_TABLE
													WHERE JOIN_CODE = M.RECEIVER))) AS savePath
		FROM MESSAGE M
		LEFT JOIN JOIN_TABLE J ON M.FORWARDER = J.JOIN_CODE
		LEFT JOIN USER_TABLE UT ON UT.USER_CODE = J.USER_CODE
		LEFT JOIN USER_INFO UI ON UI.USER_ID = UT.USER_ID
		LEFT JOIN REPORT_MESSAGE MR ON MR.MESSAGE_CODE = M.MESSAGE_CODE
		LEFT JOIN REPORT_MESSAGE_PROCESS MRP ON MR.REPORT_MESSAGE_CODE = MRP.REPORT_MESSAGE_CODE
		WHERE M.FORWARDER = #{joinCode }
		  AND J.GROUP_APPLY_CODE = #{groupApplyCode}
		  AND M.F_DELETE_DATE IS NULL
		  AND MR.MESSAGE_CODE IS NULL
		ORDER BY M.CREATED_DATE DESC 
	</select>
	
	<!-- 내가 받은 쪽지들 -->
	<select id="getForwardedMessage" resultType="com.test.mybatis.dto.MessageDTO">
		SELECT M.MESSAGE_CODE AS messageCode
			 , M.FORWARDER AS forwarder
			 , (SELECT NICKNAME
				FROM USER_INFO
				WHERE USER_ID = (SELECT USER_ID
								 FROM USER_TABLE
								 WHERE USER_CODE = (SELECT USER_CODE
													FROM JOIN_TABLE
													WHERE JOIN_CODE = M.FORWARDER))) AS nickName
			 , M.READ_DATE AS readDate
			 , M.CONTENT AS content
			 , M.CREATED_DATE AS createdDate
			 , (SELECT SAVEPATH
				FROM USER_INFO
				WHERE USER_ID = (SELECT USER_ID
								 FROM USER_TABLE
								 WHERE USER_CODE = (SELECT USER_CODE
													FROM JOIN_TABLE
													WHERE JOIN_CODE = M.FORWARDER))) AS savePath
		FROM MESSAGE M
		LEFT JOIN JOIN_TABLE J ON M.FORWARDER = J.JOIN_CODE
		LEFT JOIN USER_TABLE UT ON UT.USER_CODE = J.USER_CODE
		LEFT JOIN USER_INFO UI ON UI.USER_ID = UT.USER_ID
		LEFT JOIN REPORT_MESSAGE MR ON MR.MESSAGE_CODE = M.MESSAGE_CODE
		LEFT JOIN REPORT_MESSAGE_PROCESS MRP ON MR.REPORT_MESSAGE_CODE = MRP.REPORT_MESSAGE_CODE
		WHERE M.RECEIVER = #{joinCode }
		  AND J.GROUP_APPLY_CODE = #{groupApplyCode}
		  AND M.R_DELETE_DATE IS NULL
		  AND MR.MESSAGE_CODE IS NULL
		ORDER BY M.CREATED_DATE DESC  
	</select>

	<select id="getUserList" parameterType="String" resultType="com.test.mybatis.dto.MessageDTO">
		SELECT DISTINCT
	        UI.NICKNAME AS nickName,
	        J.JOIN_CODE AS receiver,
			NVL(CASE WHEN MP.GRANT_TYPE = 1 THEN PST.TYPE ELSE '모임원' END, '모임원') AS position
	    FROM
	        REQUEST_ANSWER RA
	    JOIN
	        JOIN_TABLE J ON RA.JOIN_CODE = J.JOIN_CODE
	    JOIN
	        GROUP_APPLY GA ON J.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE
	    LEFT JOIN
	        QUIT_MEMBER QM ON RA.JOIN_CODE = QM.JOIN_CODE 
	    JOIN
	        USER_TABLE UT ON UT.USER_CODE = J.USER_CODE
	    JOIN
	        USER_INFO UI ON UI.USER_ID = UT.USER_ID
	    LEFT JOIN (
	        SELECT JOIN_CODE, POSITION_TYPE, GRANT_TYPE,
	               ROW_NUMBER() OVER (PARTITION BY JOIN_CODE ORDER BY CREATED_DATE DESC) AS RN
	        FROM MEMBER_POSITION
	    ) MP ON RA.JOIN_CODE = MP.JOIN_CODE AND MP.RN = 1
	    LEFT JOIN POSITION_TYPE PST ON MP.POSITION_TYPE = PST.POSITION_TYPE
	    WHERE
	        RA.ANSWER_TYPE = 1  
	    AND J.GROUP_APPLY_CODE = #{groupApplyCode}
	    AND QM.JOIN_CODE IS NULL  
	    AND (MP.GRANT_TYPE IN (1,2) OR MP.JOIN_CODE IS NULL) 
	    AND NOT EXISTS (
	        SELECT 1 FROM REPORT_MEMBER RM
	        JOIN REPORT_MEMBER_PROCESS RMP ON RM.REPORT_MEMBER_CODE = RMP.REPORT_MEMBER_CODE
	        WHERE RM.REPORTEE_CODE = RA.JOIN_CODE
	          AND RMP.PROCESS_TYPE = 1 
	    )
	    AND NOT EXISTS (
	        SELECT 1 FROM ACTIVITY A
	        JOIN REPORT_ACTIVITY RA2 ON RA2.ACTIVITY_CODE = A.ACTIVITY_CODE
	        JOIN REPORT_ACTIVITY_PROCESS RAP ON RAP.REPORT_ACTIVITY_CODE = RA2.REPORT_ACTIVITY_CODE
	        WHERE A.JOIN_CODE = RA.JOIN_CODE
	          AND RAP.PROCESS_TYPE = 4 
	    )
	    AND NOT EXISTS (
	        SELECT 1 FROM POST P
	        JOIN REPORT_POST RP ON RP.POST_CODE = P.POST_CODE
	        JOIN REPORT_POST_PROCESS RPP ON RPP.REPORT_POST_CODE = RP.REPORT_POST_CODE
	        WHERE P.JOIN_CODE = RA.JOIN_CODE
	          AND RPP.PROCESS_TYPE = 4
	    )
	    AND NOT EXISTS (
	        SELECT 1 FROM POST_COMMENT PC
	        JOIN REPORT_COMMENT RC ON RC.COMMENT_CODE = PC.COMMENT_CODE
	        JOIN REPORT_COMMENT_PROCESS RCP ON RCP.REPORT_COMMENT_CODE = RC.REPORT_COMMENT_CODE
	        WHERE PC.JOIN_CODE = RA.JOIN_CODE
	          AND RCP.PROCESS_TYPE = 4
	    )
	    AND NOT EXISTS (
	        SELECT 1 FROM CHALLENGE C
	        JOIN REPORT_CHALLENGE RC ON RC.CHALLENGE_CODE = C.CHALLENGE_CODE
	        JOIN REPORT_CHALLENGE_PROCESS RCP ON RCP.REPORT_CHALLENGE_CODE = RC.REPORT_CHALLENGE_CODE
	        WHERE C.JOIN_CODE = RA.JOIN_CODE
	          AND RCP.PROCESS_TYPE = 4
	    )
	    AND NOT EXISTS (
	        SELECT 1 FROM CHALLENGE_COMMENT CC
	        JOIN REPORT_CHALLENGE_COMMENT RCC ON RCC.CHALLENGE_COMMENT_CODE = CC.CHALLENGE_COMMENT_CODE
	        JOIN REPORT_CHALLENGE_COMMENT_PROC RCCP
	          ON RCCP.REPORT_CHALLENGE_COMMENT_CODE = RCC.REPORT_CHALLENGE_COMMENT_CODE
	        WHERE CC.JOIN_CODE = RA.JOIN_CODE
	          AND RCCP.PROCESS_TYPE = 4
	    )
	    AND NOT EXISTS (
	        SELECT 1 FROM MESSAGE MS
	        JOIN REPORT_MESSAGE RM2 ON RM2.MESSAGE_CODE = MS.MESSAGE_CODE
	        JOIN REPORT_MESSAGE_PROCESS RMP2 ON RMP2.REPORT_MESSAGE_CODE = RM2.REPORT_MESSAGE_CODE
	        WHERE MS.FORWARDER = RA.JOIN_CODE
	          AND RMP2.PROCESS_TYPE = 4
	    )
	    AND NOT EXISTS (
	        SELECT 1 FROM REPORT_USER_INFO RUI
	        JOIN REPORT_USER_INFO_PROCESS RUIP
	          ON RUIP.REPORT_USER_INFO_CODE = RUI.REPORT_USER_INFO_CODE
	        WHERE RUI.REPORTEE = J.USER_CODE
	          AND RUIP.PROCESS_TYPE = 4
	    )
	    AND NOT EXISTS (
	        SELECT 1 FROM JOIN_TABLE JT
	        JOIN REPORT_INTRODUCE RIN ON RIN.JOIN_CODE = JT.JOIN_CODE
	        JOIN REPORT_INTRODUCE_PROCESS RINP ON RINP.REPORT_INTRODUCE_CODE = RIN.REPORT_INTRODUCE_CODE
	        WHERE JT.JOIN_CODE = J.USER_CODE
	          AND RINP.PROCESS_TYPE = 4
	    )
	    AND NOT EXISTS (
	        SELECT 1 FROM JOIN_TABLE JT
	        JOIN REPORT_JOIN_REQUEST RJQ ON RJQ.JOIN_CODE = JT.JOIN_CODE
	        JOIN REPORT_JOIN_REQUEST_PROCESS RJQP ON RJQP.REPORT_JOIN_CODE = RJQ.REPORT_JOIN_CODE
	        WHERE JT.JOIN_CODE = J.USER_CODE
	          AND RJQP.PROCESS_TYPE = 4
	    )
	    ORDER BY position DESC, UI.NICKNAME ASC
	</select>

	<insert id="sendMessage">
		INSERT INTO MESSAGE(MESSAGE_CODE, FORWARDER, RECEIVER, CONTENT)
		VALUES(MESSAGE_SEQ.NEXTVAL, #{forwarder}, #{receiver}, #{content})
	</insert>
	
	<update id="readMessage">
		UPDATE MESSAGE
		SET READ_DATE = SYSDATE
		WHERE MESSAGE_CODE = #{messageCode}
	</update>
</mapper>
