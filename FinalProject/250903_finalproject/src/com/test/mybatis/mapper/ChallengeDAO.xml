<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.mybatis.dao.IChallengeDAO">

	<select id="challengeAtHome" resultType="com.test.mybatis.dto.ChallengeDTO">
		SELECT C.CHALLENGE_CODE AS CHALLENGECODE, C.START_DATE AS STARTDATE, T.END_DATE AS ENDDATE
		     , C.TITLE AS TITLE, C.JOIN_CODE AS JOINCODE
		     , C.CONTENT AS CONTENT, C.CHALLENGE_TYPE AS CHALLENGETYPE, C.CREATED_DATE AS CREATEDDATE
		     , CASE WHEN (SYSDATE BETWEEN C.START_DATE AND T.END_DATE) THEN '진행중'
		            WHEN (SYSDATE &lt; C.START_DATE) THEN '진행예정'
		            WHEN (SYSDATE &gt; T.END_DATE) THEN '종료'
		            ELSE '오류 발생'
		       END AS STATUS
		     , GA.GROUP_APPLY_CODE AS GROUPAPPLYCODE
		     , (CASE WHEN C.CHALLENGE_TYPE = 1 THEN 'DAY ' || LEAST(TRUNC(SYSDATE - C.START_DATE)+1, 7) || '/7'
		             ELSE 'WEEK ' || LEAST(TRUNC(SYSDATE - C.START_DATE)+1 / 7, 5) || '/5'
		        END) AS DATEPERCENT
		     , UT.USER_CODE
		     , (SELECT COUNT(CM.CHALLENGE_MEMBER_CODE)
		        FROM CHALLENGE_MEMBER CM
		        WHERE CM.CHALLENGE_CODE = C.CHALLENGE_CODE) AS CHALLENGEMEMBER
		     , (SELECT COUNT(CD.CHALLENGE_DETAIL_CODE)
		        FROM CHALLENGE_DETAIL CD
		        WHERE CD.CHALLENGE_CODE = C.CHALLENGE_CODE
		       ) AS CHALLENGEDETAIL
		     , (SELECT COUNT(CC.CHALLENGE_MEMBER_CODE)
		        FROM CHALLENGE_CHECK CC
		        JOIN CHALLENGE_DETAIL CD ON CD.CHALLENGE_DETAIL_CODE = CC.CHALLENGE_DETAIL_CODE
		        WHERE CD.CHALLENGE_CODE = C.CHALLENGE_CODE) AS CHALLENGECHECK
		FROM CHALLENGE C
		JOIN
		(
		SELECT (START_DATE + CASE CHALLENGE_TYPE WHEN 1 THEN 7 ELSE 7*5 END) AS END_DATE
		     , CHALLENGE_CODE
		FROM CHALLENGE
		) T ON C.CHALLENGE_CODE = T.CHALLENGE_CODE
		JOIN JOIN_TABLE J ON J.JOIN_CODE = C.JOIN_CODE
		JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
		LEFT JOIN CHALLENGE_MEMBER CM ON CM.CHALLENGE_CODE = C.CHALLENGE_CODE
		LEFT JOIN JOIN_TABLE CMJ ON CMJ.JOIN_CODE = CM.JOIN_CODE
		LEFT JOIN USER_TABLE UT ON UT.USER_CODE = CMJ.USER_CODE
		WHERE UT.USER_CODE = #{userCode}
		AND GA.GROUP_APPLY_CODE = #{groupApplyCode}
	</select>

</mapper>