<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.mybatis.dao.IChallengeDAO">

	<select id="challengeAtHome" resultType="com.test.mybatis.dto.ChallengeDTO">
		SELECT C.CHALLENGE_CODE AS CHALLENGECODE, C.START_DATE AS STARTDATE, T.END_DATE AS ENDDATE
		     , C.TITLE AS TITLE, C.JOIN_CODE AS JOINCODE
		     , C.CONTENT AS CONTENT, C.CHALLENGE_TYPE AS CHALLENGETYPE, C.CREATED_DATE AS CREATEDDATE
		     , CASE WHEN (SYSDATE BETWEEN C.START_DATE AND T.END_DATE) THEN '진행중'
		            WHEN (SYSDATE &lt; C.START_DATE) THEN '진행예정'
		            WHEN (SYSDATE &gt; T.END_DATE) THEN '종료'
		            ELSE '오류 발생'
		       END AS STATUS
		     , GA.GROUP_APPLY_CODE AS GROUPAPPLYCODE
		     , (CASE WHEN C.CHALLENGE_TYPE = 1 THEN 'DAY ' || LEAST(TRUNC(SYSDATE - C.START_DATE)+1, 7) || '/7'
		             ELSE 'WEEK ' || LEAST(TRUNC(SYSDATE - C.START_DATE)+1 / 7, 5) || '/5'
		        END) AS DATEPERCENT
		     , UT.USER_CODE
		     , (SELECT COUNT(CM.CHALLENGE_MEMBER_CODE)
		        FROM CHALLENGE_MEMBER CM
		        WHERE CM.CHALLENGE_CODE = C.CHALLENGE_CODE) AS CHALLENGEMEMBER
		     , (SELECT COUNT(CD.CHALLENGE_DETAIL_CODE)
		        FROM CHALLENGE_DETAIL CD
		        WHERE CD.CHALLENGE_CODE = C.CHALLENGE_CODE
		       ) AS CHALLENGEDETAIL
		     , (SELECT COUNT(CC.CHALLENGE_MEMBER_CODE)
		        FROM CHALLENGE_CHECK CC
		        JOIN CHALLENGE_DETAIL CD ON CD.CHALLENGE_DETAIL_CODE = CC.CHALLENGE_DETAIL_CODE
		        WHERE CD.CHALLENGE_CODE = C.CHALLENGE_CODE) AS CHALLENGECHECK
		FROM CHALLENGE C
		JOIN
		(
		SELECT (START_DATE + CASE CHALLENGE_TYPE WHEN 1 THEN 7 ELSE 7*5 END) AS END_DATE
		     , CHALLENGE_CODE
		FROM CHALLENGE
		) T ON C.CHALLENGE_CODE = T.CHALLENGE_CODE
		JOIN JOIN_TABLE J ON J.JOIN_CODE = C.JOIN_CODE
		JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
		LEFT JOIN CHALLENGE_MEMBER CM ON CM.CHALLENGE_CODE = C.CHALLENGE_CODE
		LEFT JOIN JOIN_TABLE CMJ ON CMJ.JOIN_CODE = CM.JOIN_CODE
		LEFT JOIN USER_TABLE UT ON UT.USER_CODE = CMJ.USER_CODE
		WHERE UT.USER_CODE = #{userCode}
		AND GA.GROUP_APPLY_CODE = #{groupApplyCode}
	</select>
	
	<select id="getJoinCodes" resultType="com.test.mybatis.dto.ChallengeDTO">
		SELECT
			JOIN_CODE AS joinCode
			, GROUP_APPLY_CODE AS groupApplyCode
		FROM
			JOIN_TABLE
		WHERE
			USER_CODE=#{userCode}
	</select>
	
	<select id="challengeList" resultType="com.test.mybatis.dto.ChallengeDTO">
		SELECT
			CHALLENGE_CODE AS challengeCode
			, JT.JOIN_CODE AS joinCode
			, CHALLENGE_TYPE AS challengeType
			, TITLE AS title
			, TO_CHAR(START_DATE, 'YYYY-MM-DD') AS startDate
			, CONTENT AS content
			, TO_CHAR(CH.CREATED_DATE, 'YYYY-MM-DD') AS createdDate
		FROM
			CHALLENGE CH
			LEFT JOIN JOIN_TABLE JT ON JT.JOIN_CODE=CH.JOIN_CODE
		WHERE
			GROUP_APPLY_CODE=#{groupApplyCode}
	</select>
	
	<select id="getChallengeDetail" resultType="com.test.mybatis.dto.ChallengeDTO">
		SELECT
			CHALLENGE_CODE AS challengeCode
			, JOIN_CODE AS joinCode
			, CHALLENGE_TYPE AS challengeType
			, TITLE AS title
			, TO_CHAR(START_DATE, 'YYYY-MM-DD') AS startDate
			, CONTENT AS content
			, CREATED_DATE AS createdDate
		FROM
			CHALLENGE
		WHERE
			CHALLENGE_CODE=#{challengeCode}
	</select>
	
	<select id="getChallengeContent" resultType="com.test.mybatis.dto.ChallengeContentDTO">
		SELECT
			ROUND AS round
			, CONTENT AS contentDetail
		FROM
			CHALLENGE_DETAIL 
		WHERE
			CHALLENGE_CODE=#{challengeCode}
	</select>
	
	<insert id="challengeCreate">
		{ CALL PRC_CHALLENGE_INSERT (
        	#{joinCode, mode=IN, jdbcType=VARCHAR}
        	, #{challengeType, mode=IN, jdbcType=NUMERIC}
        	, #{title, mode=IN, jdbcType=VARCHAR}
        	, #{startDate, mode=IN, jdbcType=DATE}
        	, #{content, mode=IN, jdbcType=VARCHAR}
        	<choose>
        		<when test="challengeType == 1">
        			, #{day1, mode=IN, jdbcType=VARCHAR}
        			, #{day2, mode=IN, jdbcType=VARCHAR}
        			, #{day3, mode=IN, jdbcType=VARCHAR}
        			, #{day4, mode=IN, jdbcType=VARCHAR}
        			, #{day5, mode=IN, jdbcType=VARCHAR}
        			, #{day6, mode=IN, jdbcType=VARCHAR}
        			, #{day7, mode=IN, jdbcType=VARCHAR}
        		</when>
        		<otherwise>
        			, #{week1, mode=IN, jdbcType=VARCHAR}
        			, #{week2, mode=IN, jdbcType=VARCHAR}
        			, #{week3, mode=IN, jdbcType=VARCHAR}
        			, #{week4, mode=IN, jdbcType=VARCHAR}
        			, #{week5, mode=IN, jdbcType=VARCHAR}
        			, null
        			, null
        		</otherwise>
        	</choose>
    	) }
	</insert>

</mapper>