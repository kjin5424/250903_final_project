<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.mybatis.dao.IChallengeDAO">

	<select id="challengeAtHome" resultType="com.test.mybatis.dto.ChallengeInfoDTO">
		SELECT C.CHALLENGE_CODE AS CHALLENGECODE, C.START_DATE AS STARTDATE, T.END_DATE AS ENDDATE
		     , C.TITLE AS TITLE, C.JOIN_CODE AS JOINCODE
		     , C.CONTENT AS CONTENT, C.CHALLENGE_TYPE AS CHALLENGETYPE, C.CREATED_DATE AS CREATEDDATE
		     , CASE WHEN (SYSDATE BETWEEN C.START_DATE AND T.END_DATE) THEN '진행중'
		            WHEN (SYSDATE &lt; C.START_DATE) THEN '진행예정'
		            WHEN (SYSDATE &gt; T.END_DATE) THEN '종료'
		            ELSE '오류 발생'
		       END AS STATUS
		     , GA.GROUP_APPLY_CODE AS GROUPAPPLYCODE
		     , (CASE WHEN C.CHALLENGE_TYPE = 1 THEN 'DAY ' || LEAST(TRUNC(SYSDATE - C.START_DATE)+1, 7) || '/7'
		             ELSE 'WEEK ' || LEAST(TRUNC(SYSDATE - C.START_DATE)+1 / 7, 5) || '/5'
		        END) AS DATEPERCENT
		     , UT.USER_CODE
		     , (SELECT COUNT(CM.CHALLENGE_MEMBER_CODE)
		        FROM CHALLENGE_MEMBER CM
		        WHERE CM.CHALLENGE_CODE = C.CHALLENGE_CODE) AS CHALLENGEMEMBER
		     , (SELECT COUNT(CD.CHALLENGE_DETAIL_CODE)
		        FROM CHALLENGE_DETAIL CD
		        WHERE CD.CHALLENGE_CODE = C.CHALLENGE_CODE
		       ) AS CHALLENGEDETAIL
		     , (SELECT COUNT(CC.CHALLENGE_MEMBER_CODE)
		        FROM CHALLENGE_CHECK CC
		        JOIN CHALLENGE_DETAIL CD ON CD.CHALLENGE_DETAIL_CODE = CC.CHALLENGE_DETAIL_CODE
		        WHERE CD.CHALLENGE_CODE = C.CHALLENGE_CODE) AS CHALLENGECHECK
		FROM CHALLENGE C
		JOIN
		(
		SELECT (START_DATE + CASE CHALLENGE_TYPE WHEN 1 THEN 7 ELSE 7*5 END) AS END_DATE
		     , CHALLENGE_CODE
		FROM CHALLENGE
		) T ON C.CHALLENGE_CODE = T.CHALLENGE_CODE
		JOIN JOIN_TABLE J ON J.JOIN_CODE = C.JOIN_CODE
		JOIN GROUP_APPLY GA ON GA.GROUP_APPLY_CODE = J.GROUP_APPLY_CODE
		LEFT JOIN CHALLENGE_MEMBER CM ON CM.CHALLENGE_CODE = C.CHALLENGE_CODE
		LEFT JOIN JOIN_TABLE CMJ ON CMJ.JOIN_CODE = CM.JOIN_CODE
		LEFT JOIN USER_TABLE UT ON UT.USER_CODE = CMJ.USER_CODE
		WHERE UT.USER_CODE = #{userCode}
		AND GA.GROUP_APPLY_CODE = #{groupApplyCode}
        AND TO_NUMBER(C.CHALLENGE_CODE) = (SELECT MIN(TO_NUMBER(C2.CHALLENGE_CODE))
                                           FROM CHALLENGE C2
                                           JOIN JOIN_TABLE J2 ON J2.JOIN_CODE = C2.JOIN_CODE
                                           LEFT JOIN CHALLENGE_MEMBER CM2 ON CM2.CHALLENGE_CODE = C2.CHALLENGE_CODE
                                           LEFT JOIN JOIN_TABLE CMJ2 ON CMJ2.JOIN_CODE = CM2.JOIN_CODE
                                           LEFT JOIN USER_TABLE UT2 ON UT2.USER_CODE = CMJ2.USER_CODE
                                           WHERE UT2.USER_CODE = UT.USER_CODE
                                           AND J2.GROUP_APPLY_CODE = GA.GROUP_APPLY_CODE)
	</select>
		
	<select id="getGroupApplyCodes" resultType="java.lang.String">
		SELECT
			GROUPAPPLYCODE
		FROM
			CURRENT_MEMBER_VIEW
		WHERE
			USERCODE=#{userCode}
	</select>
	
	<select id="challengeList" resultType="com.test.mybatis.dto.ChallengeInfoDTO">
		SELECT
			CHALLENGE_CODE AS challengeCode
			, JT.JOIN_CODE AS joinCode
			, CHALLENGE_TYPE AS challengeType
			, TITLE AS title
			, TO_CHAR(START_DATE, 'YYYY-MM-DD') AS startDate
			, CONTENT AS content
			, TO_CHAR(CH.CREATED_DATE, 'YYYY-MM-DD') AS createdDate
		FROM
			CHALLENGE CH
			LEFT JOIN JOIN_TABLE JT ON JT.JOIN_CODE=CH.JOIN_CODE
		WHERE
			GROUP_APPLY_CODE=#{groupApplyCode}
	</select>
	
	<select id="getNickname" resultType="java.lang.String">
		SELECT
			NICKNAME AS nickname
		FROM
			JOIN_TABLE JT
			LEFT JOIN USER_TABLE UT ON UT.USER_CODE=JT.USER_CODE
			LEFT JOIN USER_INFO UI ON UI.USER_ID=UT.USER_ID
		WHERE
			JOIN_CODE=#{joinCode}
	</select>
	
	<select id="getJoinCodeFromUCGA" resultType="java.lang.String">
		SELECT
			MAX(JOIN_CODE) AS joinCode
		FROM
			JOIN_TABLE
		WHERE
			USER_CODE=#{userCode}
			AND GROUP_APPLY_CODE=#{groupApplyCode}
	</select>

	<insert id="challengeCreate">
		{ CALL PRC_CHALLENGE_INSERT (
        	#{joinCode, mode=IN, jdbcType=VARCHAR}
        	, #{challengeType, mode=IN, jdbcType=NUMERIC}
        	, #{title, mode=IN, jdbcType=VARCHAR}
        	, #{startDate, mode=IN, jdbcType=DATE}
        	, #{content, mode=IN, jdbcType=VARCHAR}
        	<choose>
        		<when test="challengeType == 1">
        			, #{day1, mode=IN, jdbcType=VARCHAR}
        			, #{day2, mode=IN, jdbcType=VARCHAR}
        			, #{day3, mode=IN, jdbcType=VARCHAR}
        			, #{day4, mode=IN, jdbcType=VARCHAR}
        			, #{day5, mode=IN, jdbcType=VARCHAR}
        			, #{day6, mode=IN, jdbcType=VARCHAR}
        			, #{day7, mode=IN, jdbcType=VARCHAR}
        		</when>
        		<otherwise>
        			, #{week1, mode=IN, jdbcType=VARCHAR}
        			, #{week2, mode=IN, jdbcType=VARCHAR}
        			, #{week3, mode=IN, jdbcType=VARCHAR}
        			, #{week4, mode=IN, jdbcType=VARCHAR}
        			, #{week5, mode=IN, jdbcType=VARCHAR}
        			, null
        			, null
        		</otherwise>
        	</choose>
    	) }
	</insert>

	<select id="getChallengeDetail" resultType="com.test.mybatis.dto.ChallengeInfoDTO">
		SELECT
			CHALLENGE_CODE AS challengeCode
			, JOIN_CODE AS joinCode
			, CHALLENGE_TYPE AS challengeType
			, TITLE AS title
			, TO_CHAR(START_DATE, 'YYYY-MM-DD') AS startDate
			, CONTENT AS content
			, CREATED_DATE AS createdDate
		FROM
			CHALLENGE
		WHERE
			CHALLENGE_CODE=#{challengeCode}
	</select>
	
	<select id="getChallengeContent" resultType="com.test.mybatis.dto.ChallengeContentDTO">
		SELECT
			CHALLENGE_DETAIL_CODE AS challengeDetailCode
			, ROUND AS round
			, CONTENT AS contentDetail
		FROM
			CHALLENGE_DETAIL 
		WHERE
			CHALLENGE_CODE=#{challengeCode}
		ORDER BY
			ROUND
	</select>
	
	<select id="getChallengerInfo" resultType="com.test.mybatis.dto.ChallengerDTO">
		SELECT 
		    CM.JOIN_CODE AS joinCode
		    , COUNT(CC.CHALLENGE_CHECK_CODE) AS successedCount
		    , CASE 
		        WHEN C.CHALLENGE_TYPE = '1' AND COUNT(CC.CHALLENGE_CHECK_CODE) = 7 THEN '달성'
		        WHEN C.CHALLENGE_TYPE = '1' AND COUNT(CC.CHALLENGE_CHECK_CODE) &lt;&gt; 7 THEN '미달성'
		        WHEN C.CHALLENGE_TYPE = '2' AND COUNT(CC.CHALLENGE_CHECK_CODE) = 5 THEN '달성'
		        WHEN C.CHALLENGE_TYPE = '2' AND COUNT(CC.CHALLENGE_CHECK_CODE) &lt;&gt; 5 THEN '미달성'
		        ELSE '오류 발생'
		      END AS successed
		FROM
			CHALLENGE_MEMBER CM
			JOIN CHALLENGE C ON CM.CHALLENGE_CODE = C.CHALLENGE_CODE
			LEFT JOIN CHALLENGE_CHECK CC ON CM.CHALLENGE_MEMBER_CODE = CC.CHALLENGE_MEMBER_CODE
			LEFT JOIN CHALLENGE_DETAIL CD ON C.CHALLENGE_CODE = CD.CHALLENGE_CODE
					AND CC.CHALLENGE_DETAIL_CODE = CD.CHALLENGE_DETAIL_CODE
		WHERE
			C.CHALLENGE_CODE = #{challengeCode}
		GROUP
			BY CM.JOIN_CODE, C.CHALLENGE_TYPE
	</select>
	
	<select id="getSuccessDate" resultType="java.lang.String">
		SELECT
			TO_CHAR(MAX(CC.CREATED_DATE), 'YYYY-MM-DD') AS 
		FROM
			CHALLENGE_MEMBER CM
			LEFT JOIN CHALLENGE_CHECK CC ON CM.CHALLENGE_MEMBER_CODE=CC.CHALLENGE_MEMBER_CODE
		WHERE
			CM.JOIN_CODE=#{joinCode}
			AND CM.CHALLENGE_CODE=#{challengeCode}
	</select>

</mapper>